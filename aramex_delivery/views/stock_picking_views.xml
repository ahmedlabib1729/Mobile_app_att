<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit Stock Picking Form -->
    <record id="view_picking_form_aramex" model="ir.ui.view">
        <field name="name">stock.picking.form.aramex</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_form"/>
        <field name="arch" type="xml">

            <!-- Add Aramex buttons in header -->
            <xpath expr="//header/button[@name='action_cancel']" position="after">
                <field name="is_aramex_carrier" invisible="1"/>
                <field name="aramex_shipment_id" invisible="1"/>

                <!-- Create Shipment Button -->
                <button name="action_create_aramex_shipment"
                        string="Create Aramex Shipment"
                        type="object"
                        class="btn-primary"
                        invisible="not is_aramex_carrier or aramex_shipment_id or state not in ['assigned', 'done'] or picking_type_code != 'outgoing'"
                        icon="fa-truck"
                        help="Create Aramex shipment for this delivery"/>

                <!-- Print Label Button -->
                <button name="action_print_aramex_label"
                        string="Print Aramex Label"
                        type="object"
                        invisible="not aramex_shipment_id or not aramex_label_pdf"
                        icon="fa-print"
                        help="Download and print Aramex shipping label"/>

                <!-- Track Shipment Button -->
                <button name="action_track_aramex_shipment"
                        string="Track Shipment"
                        type="object"
                        invisible="not aramex_shipment_id or not aramex_tracking_url"
                        icon="fa-globe"
                        help="Track this shipment on Aramex website"/>

                <!-- Update Tracking Button -->
                <button name="action_update_aramex_tracking"
                        string="Update Tracking"
                        type="object"
                        invisible="not aramex_shipment_id or aramex_shipment_state in ['delivered', 'cancelled']"
                        icon="fa-refresh"
                        help="Manually update tracking information"/>

                <!-- Cancel Shipment Button -->
                <button name="action_cancel_aramex_shipment"
                        string="Cancel Aramex Shipment"
                        type="object"
                        invisible="not aramex_shipment_id or aramex_shipment_state not in ['draft', 'confirmed']"
                        confirm="Are you sure you want to cancel this Aramex shipment? This action cannot be undone."
                        icon="fa-times-circle"
                        help="Cancel this Aramex shipment"/>
            </xpath>

            <!-- Add Aramex info in button box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button"
                        icon="fa-truck"
                        invisible="not aramex_shipment_id"
                        type="object"
                        name="action_view_aramex_shipment">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Aramex</span>
                        <span class="o_stat_value">
                            <field name="aramex_awb" readonly="1"/>
                        </span>
                    </div>
                </button>
            </xpath>

            <!-- Add Aramex page in notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="Aramex Express"
                      name="aramex_info"
                      invisible="not is_aramex_carrier">

                    <!-- Shipment Status Alert -->
                    <div class="alert alert-success"
                         role="alert"
                         invisible="not aramex_shipment_id">
                        <div class="row">
                            <div class="col-md-8">
                                <h4 class="alert-heading">
                                    <i class="fa fa-check-circle"/> Aramex Shipment Created
                                </h4>
                                <p class="mb-0">
                                    <strong>AWB Number:</strong> <field name="aramex_awb" class="d-inline font-weight-bold"/>
                                    <br/>
                                    <strong>Status:</strong>
                                    <field name="aramex_shipment_state"
                                           widget="badge"
                                           class="d-inline"
                                           decoration-success="aramex_shipment_state == 'delivered'"
                                           decoration-info="aramex_shipment_state in ['in_transit', 'out_for_delivery']"
                                           decoration-warning="aramex_shipment_state in ['confirmed', 'picked_up']"
                                           decoration-danger="aramex_shipment_state == 'cancelled'"/>
                                </p>
                            </div>
                            <div class="col-md-4 text-right">
                                <button name="action_track_aramex_shipment"
                                        string="Track Online"
                                        type="object"
                                        class="btn btn-sm btn-primary"
                                        icon="fa-external-link"
                                        invisible="not aramex_tracking_url"/>
                                <button name="action_print_aramex_label"
                                        string="Print Label"
                                        type="object"
                                        class="btn btn-sm btn-secondary ml-2"
                                        icon="fa-print"
                                        invisible="not aramex_label_pdf"/>
                            </div>
                        </div>
                    </div>

                    <!-- No Shipment Warning -->
                    <div class="alert alert-warning"
                         role="alert"
                         invisible="aramex_shipment_id or state not in ['assigned', 'done']">
                        <h4 class="alert-heading">
                            <i class="fa fa-exclamation-triangle"/> No Aramex Shipment
                        </h4>
                        <p>Click "Create Aramex Shipment" button to create a shipment for this delivery.</p>
                        <p class="mb-0">
                            <strong>Before creating shipment, ensure:</strong>
                            <ul>
                                <li>Customer address is complete (Country, City, Phone)</li>
                                <li>All products have Internal Reference (SKU)</li>
                                <li>Delivery is ready or done</li>
                            </ul>
                        </p>
                    </div>

                    <!-- Shipment Information -->
                    <group invisible="not aramex_shipment_id">
                        <group string="Shipment Information">
                            <field name="carrier_id" readonly="1"/>
                            <field name="aramex_shipment_id"
                                   readonly="1"
                                   options="{'no_open': False}"/>
                            <field name="aramex_awb" readonly="1"/>
                            <field name="aramex_service_type" readonly="1"/>
                        </group>
                        <group string="Financial">
                            <field name="aramex_cod_amount"
                                   readonly="1"
                                   widget="monetary"
                                   invisible="aramex_cod_amount == 0"/>
                            <field name="sale_id" readonly="1" invisible="1"/>
                            <field name="currency_id" invisible="1"/>
                        </group>
                    </group>

                    <!-- Tracking & Documents -->
                    <group invisible="not aramex_shipment_id">
                        <group string="Tracking Information">
                            <field name="aramex_tracking_url"
                                   widget="url"
                                   readonly="1"
                                   string="Tracking Link"/>
                            <field name="aramex_shipment_state"
                                   readonly="1"
                                   widget="badge"/>
                        </group>
                        <group string="Pickup Information">
                            <field name="aramex_pickup_guid"
                                   readonly="1"
                                   invisible="not aramex_pickup_guid"/>
                            <field name="aramex_foreign_hawb"
                                   readonly="state != 'draft'"
                                   invisible="not aramex_foreign_hawb"/>
                        </group>
                    </group>

                    <!-- Documents Section -->
                    <group string="Documents" invisible="not aramex_label_pdf">
                        <field name="aramex_label_pdf"
                               filename="aramex_label_filename"
                               readonly="1"/>
                        <field name="aramex_label_filename" invisible="1"/>
                    </group>

                    <!-- Products Check -->
                    <separator string="Products to Ship" class="mt-3"/>
                    <field name="move_ids" readonly="1" mode="tree">
                        <tree>
                            <field name="product_id"/>
                            <field name="product_uom_qty" string="Demand"/>
                            <field name="quantity" string="Done"/>
                            <field name="product_uom" groups="uom.group_uom"/>
                        </tree>
                    </field>

                    <div class="alert alert-danger mt-2"
                         role="alert"
                         invisible="not is_aramex_carrier or aramex_shipment_id">
                        <p class="mb-0">
                            <i class="fa fa-exclamation-circle"/>
                            Products highlighted in <span class="text-danger">red</span> are missing Internal Reference (SKU) and cannot be shipped with Aramex.
                        </p>
                    </div>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Inherit Stock Picking Tree -->
    <record id="view_picking_tree_aramex" model="ir.ui.view">
        <field name="name">stock.picking.tree.aramex</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.vpicktree"/>
        <field name="arch" type="xml">
            <!-- Add Aramex columns -->
            <xpath expr="//field[@name='state']" position="before">
                <field name="is_aramex_carrier" invisible="1"/>
                <field name="aramex_awb"
                       string="Aramex AWB"
                       optional="show"/>
                <field name="aramex_shipment_state"
                       string="Aramex Status"
                       widget="badge"
                       optional="show"
                       invisible="not is_aramex_carrier"
                       decoration-success="aramex_shipment_state == 'delivered'"
                       decoration-info="aramex_shipment_state in ['in_transit', 'out_for_delivery']"
                       decoration-warning="aramex_shipment_state in ['confirmed', 'picked_up']"
                       decoration-danger="aramex_shipment_state == 'cancelled'"/>
                <field name="aramex_cod_amount"
                       string="COD"
                       widget="monetary"
                       optional="hide"
                       invisible="not is_aramex_carrier"/>
            </xpath>
        </field>
    </record>

    <!-- Inherit Stock Picking Search -->
    <record id="view_picking_search_aramex" model="ir.ui.view">
        <field name="name">stock.picking.search.aramex</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_internal_search"/>
        <field name="arch" type="xml">
            <!-- Add Aramex filters -->
            <xpath expr="//filter[@name='starred']" position="after">
                <separator/>
                <filter string="Aramex Deliveries"
                        name="aramex_deliveries"
                        domain="[('is_aramex_carrier', '=', True)]"
                        help="Deliveries using Aramex"/>
                <filter string="Has Aramex Shipment"
                        name="has_aramex"
                        domain="[('aramex_shipment_id', '!=', False)]"
                        help="Deliveries with Aramex shipment created"/>
                <filter string="No Aramex Shipment"
                        name="no_aramex"
                        domain="[('is_aramex_carrier', '=', True), ('aramex_shipment_id', '=', False)]"
                        help="Aramex deliveries without shipment"/>
                <separator/>
                <filter string="Aramex In Transit"
                        name="aramex_transit"
                        domain="[('aramex_shipment_state', 'in', ['in_transit', 'out_for_delivery', 'picked_up'])]"/>
                <filter string="Aramex Delivered"
                        name="aramex_delivered"
                        domain="[('aramex_shipment_state', '=', 'delivered')]"/>
            </xpath>

            <!-- Add search fields -->
            <xpath expr="//field[@name='name']" position="after">
                <field name="aramex_awb" string="Aramex AWB"/>
            </xpath>

            <!-- Add group by -->
            <xpath expr="//group" position="inside">
                <filter string="Aramex Status"
                        name="group_aramex_status"
                        context="{'group_by': 'aramex_shipment_state'}"/>
            </xpath>
        </field>
    </record>

    <!-- Action for Aramex Deliveries -->
    <record id="action_aramex_deliveries" model="ir.actions.act_window">
        <field name="name">Aramex Deliveries</field>
        <field name="res_model">stock.picking</field>
        <field name="view_mode">tree,form,kanban</field>
        <field name="domain">[('is_aramex_carrier', '=', True), ('picking_type_code', '=', 'outgoing')]</field>
        <field name="context">{
            'search_default_available': 1,
            'search_default_no_aramex': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No Aramex deliveries found
            </p>
            <p>
                Delivery orders using Aramex will appear here.
            </p>
        </field>
    </record>

    <!-- Menu for Aramex Deliveries -->
    <menuitem id="menu_aramex_deliveries"
              name="Deliveries"
              parent="menu_aramex_root"
              action="action_aramex_deliveries"
              sequence="40"/>
</odoo>