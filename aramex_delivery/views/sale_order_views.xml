<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit Sale Order Form -->
    <record id="view_order_form_aramex" model="ir.ui.view">
        <field name="name">sale.order.form.aramex</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="priority">20</field>
        <field name="arch" type="xml">

            <!-- Add Aramex shipment button in header button box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <!-- Aramex Shipments Button -->
                <button name="action_view_aramex_shipments"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-truck"
                        invisible="aramex_shipment_count == 0">
                    <field name="aramex_shipment_count"
                           widget="statinfo"
                           string="Aramex"/>
                </button>

                <!-- Create Aramex Shipments Button -->
                <button name="action_create_aramex_shipments"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-plus-circle"
                        invisible="not is_aramex_carrier or aramex_shipment_count > 0 or state != 'sale'"
                        help="Create Aramex shipments for all deliveries">
                    <div class="o_stat_info">
                        <span class="o_stat_text">Create Aramex</span>
                    </div>
                </button>
            </xpath>

            <!-- Add Aramex info after payment term -->
            <xpath expr="//field[@name='payment_term_id']" position="after">
                <field name="is_aramex_carrier" invisible="1"/>
                <field name="carrier_id" invisible="1"/>
                <field name="aramex_service_type"
                       invisible="not is_aramex_carrier"
                       readonly="1"
                       help="Aramex service type from selected carrier"/>
                <field name="aramex_product_group"
                       invisible="not is_aramex_carrier"
                       readonly="1"/>
            </xpath>

            <!-- Add COD indicator if Aramex -->
            <xpath expr="//field[@name='payment_term_id']" position="after">
                <field name="is_cod_payment"
                       invisible="not is_aramex_carrier"
                       readonly="1"
                       widget="boolean_toggle"/>
                <field name="cod_amount"
                       invisible="not is_cod_payment or not is_aramex_carrier"
                       readonly="1"
                       widget="monetary"/>
            </xpath>

            <!-- Add Aramex status in statusbar area -->
            <xpath expr="//field[@name='state']" position="before">
                <field name="aramex_shipment_state"
                       widget="badge"
                       invisible="not is_aramex_carrier or aramex_shipment_state == 'none'"
                       decoration-success="aramex_shipment_state == 'delivered'"
                       decoration-info="aramex_shipment_state in ['in_transit', 'out_for_delivery']"
                       decoration-warning="aramex_shipment_state in ['confirmed', 'picked_up']"
                       decoration-danger="aramex_shipment_state == 'cancelled'"/>
            </xpath>

            <!-- Add Aramex tab in notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="Aramex Express"
                      name="aramex_info"
                      invisible="not is_aramex_carrier">

                    <!-- Quick Actions -->
                    <div class="alert alert-info"
                         role="alert"
                         invisible="aramex_shipment_count == 0">
                        <div class="row">
                            <div class="col-md-8">
                                <h4 class="alert-heading">
                                    <i class="fa fa-truck"/> Aramex Shipment Information
                                </h4>
                                <p class="mb-0">
                                    <strong>Status:</strong>
                                    <field name="aramex_shipment_state" class="d-inline"/>
                                </p>
                            </div>
                            <div class="col-md-4 text-right">
                                <button name="action_open_aramex_tracking"
                                        string="Track All Shipments"
                                        type="object"
                                        class="btn btn-primary"
                                        icon="fa-external-link"
                                        invisible="not aramex_tracking_urls"/>
                                <button name="action_print_all_aramex_labels"
                                        string="Print All Labels"
                                        type="object"
                                        class="btn btn-secondary ml-2"
                                        icon="fa-print"
                                        invisible="aramex_shipment_count == 0"/>
                            </div>
                        </div>
                    </div>

                    <group>
                        <group string="Shipment Information">
                            <field name="aramex_awb_numbers"
                                   readonly="1"
                                   widget="text"
                                   invisible="not aramex_awb_numbers"/>
                            <field name="aramex_pickup_ids"
                                   readonly="1"
                                   invisible="not aramex_pickup_ids"/>
                        </group>
                        <group string="Service Details">
                            <field name="carrier_id" readonly="1"/>
                            <field name="aramex_service_type" readonly="1"/>
                            <field name="is_cod_payment"
                                   readonly="1"
                                   string="COD Payment"/>
                            <field name="cod_amount"
                                   readonly="1"
                                   invisible="not is_cod_payment"/>
                        </group>
                    </group>

                    <!-- Tracking URLs -->
                    <group string="Tracking" invisible="not aramex_tracking_urls">
                        <field name="aramex_tracking_urls"
                               widget="url"
                               readonly="1"
                               nolabel="1"/>
                    </group>

                    <!-- List of shipments -->
                    <separator string="Aramex Shipments"
                               invisible="aramex_shipment_count == 0"
                               class="mt-3"/>
                    <field name="aramex_shipment_ids"
                           readonly="1"
                           invisible="aramex_shipment_count == 0"
                           nolabel="1">
                        <tree decoration-success="state == 'delivered'"
                              decoration-info="state in ['in_transit', 'out_for_delivery']"
                              decoration-warning="state in ['confirmed', 'picked_up']"
                              decoration-danger="state == 'cancelled'">
                            <field name="awb_number" string="AWB Number"/>
                            <field name="reference1" string="Reference"/>
                            <field name="product_type" string="Service"/>
                            <field name="number_of_pieces" string="Pieces"/>
                            <field name="actual_weight" string="Weight (KG)"/>
                            <field name="cod_amount"
                                   string="COD"
                                   widget="monetary"
                                   optional="show"/>
                            <field name="state"
                                   widget="badge"
                                   decoration-success="state == 'delivered'"
                                   decoration-info="state in ['in_transit', 'out_for_delivery']"
                                   decoration-warning="state in ['confirmed', 'picked_up']"
                                   decoration-danger="state == 'cancelled'"/>
                            <field name="pickup_date" optional="show"/>
                            <button name="action_track_shipment"
                                    type="object"
                                    string="Track"
                                    icon="fa-globe"
                                    class="btn-link"/>
                            <button name="action_print_label"
                                    type="object"
                                    string="Label"
                                    icon="fa-print"
                                    class="btn-link"/>
                        </tree>
                    </field>

                    <!-- Warnings Section -->
                    <div class="alert alert-warning mt-3"
                         role="alert"
                         invisible="aramex_shipment_count > 0 or state != 'sale'">
                        <h4 class="alert-heading">
                            <i class="fa fa-exclamation-triangle"/> No Aramex Shipments Created
                        </h4>
                        <p>Click "Create Aramex" button above to create shipments for this order.</p>
                        <p class="mb-0">
                            <strong>Requirements:</strong>
                            <ul>
                                <li>Order must be confirmed</li>
                                <li>Delivery orders must be created</li>
                                <li>Customer address must be complete</li>
                                <li>Products must have Internal Reference (SKU)</li>
                            </ul>
                        </p>
                    </div>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Inherit Sale Order Tree View -->
    <record id="view_order_tree_aramex" model="ir.ui.view">
        <field name="name">sale.order.tree.aramex</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_tree"/>
        <field name="arch" type="xml">
            <!-- Add Aramex columns -->
            <xpath expr="//field[@name='state']" position="before">
                <field name="carrier_id"
                       optional="show"
                       string="Delivery Method"/>
                <field name="is_aramex_carrier" invisible="1"/>
                <field name="aramex_awb_numbers"
                       optional="hide"
                       string="Aramex AWB"
                       widget="text"/>
                <field name="aramex_shipment_state"
                       optional="show"
                       string="Aramex Status"
                       widget="badge"
                       invisible="not is_aramex_carrier"
                       decoration-success="aramex_shipment_state == 'delivered'"
                       decoration-info="aramex_shipment_state in ['in_transit', 'out_for_delivery']"
                       decoration-warning="aramex_shipment_state in ['confirmed', 'picked_up']"
                       decoration-danger="aramex_shipment_state == 'cancelled'"/>
                <field name="is_cod_payment"
                       optional="show"
                       string="COD"
                       widget="boolean_toggle"
                       invisible="not is_aramex_carrier"/>
            </xpath>
        </field>
    </record>

    <!-- Inherit Sale Order Search View -->
    <record id="view_sales_order_filter_aramex" model="ir.ui.view">
        <field name="name">sale.order.search.aramex</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sales_order_filter"/>
        <field name="arch" type="xml">
            <!-- Add Aramex filters -->
            <xpath expr="//filter[@name='my_sale_orders_filter']" position="after">
                <separator/>
                <filter string="Aramex Orders"
                        name="aramex_orders"
                        domain="[('is_aramex_carrier', '=', True)]"
                        help="Orders using Aramex delivery"/>
                <filter string="Has Aramex Shipment"
                        name="has_aramex_shipment"
                        domain="[('aramex_shipment_count', '>', 0)]"
                        help="Orders with Aramex shipments created"/>
                <filter string="Aramex COD"
                        name="aramex_cod"
                        domain="[('is_aramex_carrier', '=', True), ('is_cod_payment', '=', True)]"
                        help="Aramex Cash on Delivery orders"/>
                <separator/>
                <filter string="Aramex Delivered"
                        name="aramex_delivered"
                        domain="[('is_aramex_carrier', '=', True), ('aramex_shipment_state', '=', 'delivered')]"/>
                <filter string="Aramex In Transit"
                        name="aramex_in_transit"
                        domain="[('is_aramex_carrier', '=', True), ('aramex_shipment_state', 'in', ['in_transit', 'out_for_delivery'])]"/>
                <filter string="Aramex Pending"
                        name="aramex_pending"
                        domain="[('is_aramex_carrier', '=', True), ('aramex_shipment_state', 'in', ['none', 'draft'])]"/>
            </xpath>

            <!-- Add group by options -->
            <xpath expr="//group" position="inside">
                <separator/>
                <filter string="Carrier"
                        name="group_by_carrier"
                        context="{'group_by': 'carrier_id'}"/>
                <filter string="Aramex Status"
                        name="group_by_aramex_status"
                        context="{'group_by': 'aramex_shipment_state'}"
                        invisible="context.get('search_default_aramex_orders', False) != True"/>
                <filter string="COD Orders"
                        name="group_by_cod"
                        context="{'group_by': 'is_cod_payment'}"/>
            </xpath>
        </field>
    </record>

    <!-- Action for Aramex Orders -->
    <record id="action_aramex_orders" model="ir.actions.act_window">
        <field name="name">Aramex Orders</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">tree,form,kanban,pivot</field>
        <field name="domain">[('is_aramex_carrier', '=', True)]</field>
        <field name="context">{
            'search_default_aramex_orders': 1,
            'search_default_order_month': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No Aramex orders found
            </p>
            <p>
                Orders using Aramex as delivery method will appear here.
            </p>
        </field>
    </record>

    <!-- Menu for Aramex Orders -->
    <menuitem id="menu_aramex_orders"
              name="Orders"
              parent="menu_aramex_root"
              action="action_aramex_orders"
              sequence="30"/>
</odoo>