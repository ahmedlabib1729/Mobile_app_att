<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ============================================ -->
    <!-- Portal Menu Integration -->
    <!-- ============================================ -->

    <!-- Add Shipments to Portal Breadcrumbs -->
    <template id="portal_my_home_menu_shipment" name="Portal layout : Shipments menu entry" inherit_id="portal.portal_breadcrumbs" priority="40">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'shipment' or shipment" t-attf-class="breadcrumb-item #{'active ' if not shipment else ''}">
                <a t-if="shipment" t-attf-href="/my/shipments?{{ keep_query() }}">Shipments</a>
                <t t-else="">Shipments</t>
            </li>
            <li t-if="shipment" class="breadcrumb-item active">
                <span t-esc="shipment.order_number"/>
            </li>
        </xpath>
    </template>

    <!-- Add Shipments Counter to Portal Home -->
    <template id="portal_my_home_shipment" name="Show Shipments" customize_show="True" inherit_id="portal.portal_my_home" priority="40">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="icon" t-value="'/shipping_management_system/static/description/icon.png'"/>
                <t t-set="title">Shipments</t>
                <t t-set="text">Track and manage your shipments</t>
                <t t-set="url" t-value="'/my/shipments'"/>
                <t t-set="placeholder_count" t-value="'shipment_count'"/>
            </t>
        </xpath>
    </template>

    <!-- ============================================ -->
    <!-- Shipments List View -->
    <!-- ============================================ -->

    <template id="portal_my_shipments" name="My Shipments">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <!-- Page Header -->
            <div class="shipment-portal-header">
                <div class="container">
                    <h2 class="mb-0"><i class="fa fa-truck mr-2"></i>My Shipments</h2>
                    <p class="mt-2 mb-0">Manage and track all your shipments in one place</p>
                </div>
            </div>

            <!-- Search Bar -->
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Shipments</t>
            </t>

            <!-- Empty State -->
            <t t-if="not shipments">
                <div class="portal-empty-state">
                    <i class="fa fa-box-open"></i>
                    <h3>No Shipments Found</h3>
                    <p class="text-muted">You haven't created any shipments yet.</p>
                    <a href="/shipment" class="btn btn-primary mt-3">
                        <i class="fa fa-plus"></i> Create New Shipment
                    </a>
                </div>
            </t>

            <!-- Shipments Table -->
            <t t-if="shipments">
                <div class="portal-shipment-table">
                    <t t-call="portal.portal_table">
                        <thead>
                            <tr class="active">
                                <th style="width: 15%">Order #</th>
                                <th style="width: 15%">Tracking #</th>
                                <th class='d-none d-md-table-cell' style="width: 12%">Date</th>
                                <th class='d-none d-md-table-cell' style="width: 18%">Recipient</th>
                                <th class='d-none d-md-table-cell' style="width: 15%">City</th>
                                <th style="width: 15%">Status</th>
                                <th class="text-right" style="width: 10%">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="shipments" t-as="shipment">
                                <tr class="fade-in-up">
                                    <td>
                                        <a t-att-href="'/my/shipment/%s' % shipment.id" class="text-primary font-weight-bold">
                                            <i class="fa fa-file-text-o mr-1"></i>
                                            <t t-esc="shipment.order_number"/>
                                        </a>
                                    </td>
                                    <td>
                                        <t t-if="shipment.tracking_number">
                                            <span class="badge badge-secondary">
                                                <i class="fa fa-barcode mr-1"></i>
                                                <t t-esc="shipment.tracking_number"/>
                                            </span>
                                        </t>
                                        <t t-else="">
                                            <span class="text-muted">-</span>
                                        </t>
                                    </td>
                                    <td class='d-none d-md-table-cell'>
                                        <span t-field="shipment.create_date" t-options='{"widget": "date"}'/>
                                    </td>
                                    <td class='d-none d-md-table-cell'>
                                        <i class="fa fa-user-o mr-1 text-muted"></i>
                                        <span t-field="shipment.recipient_name"/>
                                    </td>
                                    <td class='d-none d-md-table-cell'>
                                        <i class="fa fa-map-marker mr-1 text-muted"></i>
                                        <span t-field="shipment.recipient_city"/>
                                    </td>
                                    <td class="tx_status">
                                        <t t-if="shipment.state == 'draft'">
                                            <span class="badge badge-info"><i class="fa fa-fw fa-file-text"/> Draft</span>
                                        </t>
                                        <t t-elif="shipment.state == 'confirmed'">
                                            <span class="badge badge-primary"><i class="fa fa-fw fa-check"/> Confirmed</span>
                                        </t>
                                        <t t-elif="shipment.state == 'picked'">
                                            <span class="badge badge-warning"><i class="fa fa-fw fa-box"/> Picked Up</span>
                                        </t>
                                        <t t-elif="shipment.state == 'in_transit'">
                                            <span class="badge badge-warning"><i class="fa fa-fw fa-truck"/> In Transit</span>
                                        </t>
                                        <t t-elif="shipment.state == 'out_for_delivery'">
                                            <span class="badge badge-warning"><i class="fa fa-fw fa-map-marker"/> Out for Delivery</span>
                                        </t>
                                        <t t-elif="shipment.state == 'delivered'">
                                            <span class="badge badge-success"><i class="fa fa-fw fa-check-circle"/> Delivered</span>
                                        </t>
                                        <t t-elif="shipment.state == 'returned'">
                                            <span class="badge badge-warning"><i class="fa fa-fw fa-undo"/> Returned</span>
                                        </t>
                                        <t t-elif="shipment.state == 'cancelled'">
                                            <span class="badge badge-danger"><i class="fa fa-fw fa-times"/> Cancelled</span>
                                        </t>
                                    </td>
                                    <td class="text-right">
                                        <strong><t t-esc="shipment.final_customer_price"/> EGP</strong>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </t>
                </div>

                <!-- Quick Stats -->
                <div class="row mt-4">
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-primary"><t t-esc="len(shipments.filtered(lambda s: s.state == 'draft'))"/></h4>
                                <p class="mb-0">Draft</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-warning"><t t-esc="len(shipments.filtered(lambda s: s.state in ['picked', 'in_transit', 'out_for_delivery']))"/></h4>
                                <p class="mb-0">In Transit</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-success"><t t-esc="len(shipments.filtered(lambda s: s.state == 'delivered'))"/></h4>
                                <p class="mb-0">Delivered</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 col-6 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-success"><t t-esc="len(shipments.filtered(lambda s: s.state == 'returned'))"/></h4>
                                <p class="mb-0">Returned</p>
                            </div>
                        </div>
                    </div>

                </div>
            </t>
        </t>
    </template>

    <!-- ============================================ -->
    <!-- Shipment Detail View -->
    <!-- ============================================ -->

    <template id="portal_my_shipment_detail" name="My Shipment Detail">
        <t t-call="portal.portal_layout">

            <!-- Admin Edit Mode -->
            <t t-set="o_portal_fullwidth_alert" groups="sales_team.group_sale_salesman">
                <t t-call="portal.portal_back_in_edit_mode">
                    <t t-set="backend_url" t-value="'/web#model=shipment.order&amp;id=%s&amp;view_type=form' % (shipment.id)"/>
                </t>
            </t>

            <div class="shipment-detail-container">
                <!-- Header -->
                <div class="shipment-detail-header fade-in-up">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="mb-2">
                                <i class="fa fa-truck mr-2"></i>
                                Shipment: <t t-esc="shipment.order_number"/>
                            </h3>
                            <p class="mb-0">
                                Created on: <t t-esc="shipment.create_date" t-options='{"widget": "date"}'/>
                            </p>
                        </div>
                        <div class="col-md-4 text-md-right mt-3 mt-md-0">
                            <!-- Status Badge -->
                            <t t-if="shipment.state == 'draft'">
                                <span class="badge badge-info h5"><i class="fa fa-fw fa-file-text"/> Draft</span>
                            </t>
                            <t t-elif="shipment.state == 'confirmed'">
                                <span class="badge badge-primary h5"><i class="fa fa-fw fa-check"/> Confirmed</span>
                            </t>
                            <t t-elif="shipment.state == 'picked'">
                                <span class="badge badge-warning h5"><i class="fa fa-fw fa-box"/> Picked Up</span>
                            </t>
                            <t t-elif="shipment.state == 'in_transit'">
                                <span class="badge badge-warning h5"><i class="fa fa-fw fa-truck"/> In Transit</span>
                            </t>
                            <t t-elif="shipment.state == 'out_for_delivery'">
                                <span class="badge badge-warning h5"><i class="fa fa-fw fa-map-marker"/> Out for Delivery</span>
                            </t>
                            <t t-elif="shipment.state == 'delivered'">
                                <span class="badge badge-success h5"><i class="fa fa-fw fa-check-circle"/> Delivered</span>
                            </t>
                            <t t-elif="shipment.state == 'returned'">
                                <span class="badge badge-warning h5"><i class="fa fa-fw fa-undo"/> Returned</span>
                            </t>
                            <t t-elif="shipment.state == 'cancelled'">
                                <span class="badge badge-danger h5"><i class="fa fa-fw fa-times"/> Cancelled</span>
                            </t>
                        </div>
                    </div>
                </div>

                <!-- Tracking Info -->
                <t t-if="shipment.tracking_number">
                    <div class="alert tracking-alert fade-in-up">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <i class="fa fa-barcode mr-2"></i>
                                <strong>Tracking Number:</strong>
                                <span class="h5 mb-0"><t t-esc="shipment.tracking_number"/></span>
                            </div>
                            <div class="col-md-4 text-md-right mt-2 mt-md-0">
                                <a t-att-href="'/shipment/track?tracking=%s' % shipment.tracking_number"
                                   class="btn btn-sm btn-primary">
                                    <i class="fa fa-search"/> Track Package
                                </a>
                            </div>
                        </div>
                    </div>
                </t>

                <!-- Shipment Details -->
                <div class="row">
                    <!-- Sender Information -->
                    <div class="col-md-6 mb-3">
                        <div class="card shipment-info-card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fa fa-user mr-2"></i>Sender Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td width="30%"><strong>Name:</strong></td>
                                        <td><t t-esc="shipment.sender_name"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Phone:</strong></td>
                                        <td><t t-esc="shipment.sender_phone"/></td>
                                    </tr>
                                    <t t-if="shipment.sender_whatsapp">
                                        <tr>
                                            <td><strong>WhatsApp:</strong></td>
                                            <td><t t-esc="shipment.sender_whatsapp"/></td>
                                        </tr>
                                    </t>
                                    <tr>
                                        <td><strong>Address:</strong></td>
                                        <td><t t-esc="shipment.sender_address"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>City:</strong></td>
                                        <td><t t-esc="shipment.sender_city"/></td>
                                    </tr>
                                    <t t-if="shipment.sender_pickup_notes">
                                        <tr>
                                            <td colspan="2">
                                                <strong>Pickup Notes:</strong><br/>
                                                <small class="text-muted"><t t-esc="shipment.sender_pickup_notes"/></small>
                                            </td>
                                        </tr>
                                    </t>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Recipient Information -->
                    <div class="col-md-6 mb-3">
                        <div class="card shipment-info-card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fa fa-map-marker mr-2"></i>Recipient Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td width="30%"><strong>Name:</strong></td>
                                        <td><t t-esc="shipment.recipient_name"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Phone:</strong></td>
                                        <td><t t-esc="shipment.recipient_phone"/></td>
                                    </tr>
                                    <t t-if="shipment.recipient_mobile">
                                        <tr>
                                            <td><strong>Alt. Phone:</strong></td>
                                            <td><t t-esc="shipment.recipient_mobile"/></td>
                                        </tr>
                                    </t>
                                    <t t-if="shipment.recipient_whatsapp">
                                        <tr>
                                            <td><strong>WhatsApp:</strong></td>
                                            <td><t t-esc="shipment.recipient_whatsapp"/></td>
                                        </tr>
                                    </t>
                                    <tr>
                                        <td><strong>Address:</strong></td>
                                        <td><t t-esc="shipment.recipient_address"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>City:</strong></td>
                                        <td><t t-esc="shipment.recipient_city"/></td>
                                    </tr>
                                    <t t-if="shipment.recipient_delivery_notes">
                                        <tr>
                                            <td colspan="2">
                                                <strong>Delivery Notes:</strong><br/>
                                                <small class="text-muted"><t t-esc="shipment.recipient_delivery_notes"/></small>
                                            </td>
                                        </tr>
                                    </t>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products -->
                <div class="card shipment-info-card mb-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fa fa-box mr-2"></i>Products (<t t-esc="len(shipment.shipment_line_ids)"/> items)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table products-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Product</th>
                                        <th>Category</th>
                                        <th>Brand</th>
                                        <th class="text-center">Qty</th>
                                        <th class="text-right">Weight</th>
                                        <th class="text-right">Value</th>
                                        <th class="text-center">Special</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="shipment.shipment_line_ids" t-as="line">
                                        <tr>
                                            <td><t t-esc="line_index + 1"/></td>
                                            <td><strong><t t-esc="line.product_name"/></strong></td>
                                            <td>
                                                <t t-if="line.category_id">
                                                    <span class="badge badge-secondary">
                                                        <t t-esc="line.category_id.name"/>
                                                    </span>
                                                </t>
                                            </td>
                                            <td>
                                                <t t-if="line.brand_id">
                                                    <t t-esc="line.brand_id.name"/>
                                                </t>
                                            </td>
                                            <td class="text-center"><t t-esc="line.quantity"/></td>
                                            <td class="text-right"><t t-esc="line.weight"/> KG</td>
                                            <td class="text-right"><t t-esc="line.product_value"/> EGP</td>
                                            <td class="text-center">
                                                <t t-if="line.fragile">
                                                    <span class="badge badge-warning" title="Fragile">
                                                        <i class="fa fa-exclamation-triangle"></i>
                                                    </span>
                                                </t>
                                                <t t-if="line.dangerous_goods">
                                                    <span class="badge badge-danger" title="Dangerous Goods">
                                                        <i class="fa fa-exclamation-circle"></i>
                                                    </span>
                                                </t>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                                <tfoot>
                                    <tr class="table-active">
                                        <td colspan="4"><strong>Totals:</strong></td>
                                        <td class="text-center">
                                            <strong><t t-esc="sum(shipment.shipment_line_ids.mapped('quantity'))"/></strong>
                                        </td>
                                        <td class="text-right">
                                            <strong><t t-esc="shipment.total_weight"/> KG</strong>
                                        </td>
                                        <td class="text-right">
                                            <strong><t t-esc="shipment.total_value"/> EGP</strong>
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Shipment Info -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card shipment-info-card">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">
                                    <i class="fa fa-info-circle mr-2"></i>Shipment Details
                                </h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td width="40%"><strong>Type:</strong></td>
                                        <td><t t-esc="dict(shipment._fields['shipment_type'].selection).get(shipment.shipment_type)"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Packages:</strong></td>
                                        <td><t t-esc="shipment.package_count"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Payment:</strong></td>
                                        <td>
                                            <t t-if="shipment.payment_method == 'prepaid'">Prepaid</t>
                                            <t t-elif="shipment.payment_method == 'cod'">
                                                COD (<t t-esc="shipment.cod_amount"/> EGP)
                                            </t>
                                            <t t-else=""><t t-esc="shipment.payment_method"/></t>
                                        </td>
                                    </tr>

                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Dates -->
                    <div class="col-md-6">
                        <div class="card shipment-info-card">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0">
                                    <i class="fa fa-calendar mr-2"></i>Timeline
                                </h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td width="40%"><strong>Created:</strong></td>
                                        <td><t t-esc="shipment.create_date" t-options='{"widget": "datetime"}'/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Pickup Date:</strong></td>
                                        <td><t t-esc="shipment.pickup_date" t-options='{"widget": "datetime"}'/></td>
                                    </tr>
                                    <t t-if="shipment.expected_delivery">
                                        <tr>
                                            <td><strong>Expected Delivery:</strong></td>
                                            <td><t t-esc="shipment.expected_delivery" t-options='{"widget": "datetime"}'/></td>
                                        </tr>
                                    </t>
                                    <t t-if="shipment.actual_delivery">
                                        <tr>
                                            <td><strong>Actual Delivery:</strong></td>
                                            <td class="text-success">
                                                <strong><t t-esc="shipment.actual_delivery" t-options='{"widget": "datetime"}'/></strong>
                                            </td>
                                        </tr>
                                    </t>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pricing Details -->
                <!-- Pricing Details -->
<div class="card pricing-card shipment-info-card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fa fa-money mr-2"></i>Pricing Details
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6 class="mb-3">Payment Information</h6>
                <table class="table table-sm table-borderless">


                    <t t-if="shipment.invoice_ids">
                        <tr>
                            <td><strong>Invoice Status:</strong></td>
                            <td>
                                <t t-foreach="shipment.invoice_ids" t-as="inv">
                                    <t t-if="inv.state == 'posted'">
                                        <span class="badge badge-success">
                                            <i class="fa fa-check-circle"></i>
                                            Confirmed - <t t-esc="inv.name"/>
                                        </span>
                                    </t>
                                    <t t-elif="inv.state == 'draft'">
                                        <span class="badge badge-warning">
                                            <i class="fa fa-clock-o"></i>
                                            Draft Invoice
                                        </span>
                                    </t>
                                </t>
                            </td>
                        </tr>
                    </t>
                    <t t-else="">
                        <tr>
                            <td><strong>Invoice:</strong></td>
                            <td>
                                <span class="badge badge-secondary">Not Created Yet</span>
                            </td>
                        </tr>
                    </t>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="mb-3">Amount Details</h6>
                <!-- Show detailed pricing only if invoice is confirmed -->
                <t t-if="shipment.invoice_ids.filtered(lambda i: i.state == 'posted')">
                    <table class="table table-sm">


                        <!-- Safe discount handling -->
                        <t t-set="has_discount" t-value="False"/>
                        <t t-set="discount_amt" t-value="0"/>
                        <t t-set="discount_pct" t-value="0"/>

                        <!-- Try to get discount values safely -->
                        <t t-foreach="shipment._fields" t-as="field_name">
                            <t t-if="field_name == 'discount_amount'">
                                <t t-set="discount_amt" t-value="shipment.discount_amount or 0"/>
                                <t t-if="discount_amt > 0">
                                    <t t-set="has_discount" t-value="True"/>
                                </t>
                            </t>
                            <t t-if="field_name == 'discount_percentage'">
                                <t t-set="discount_pct" t-value="shipment.discount_percentage or 0"/>
                            </t>
                        </t>

                        <t t-if="has_discount">
                            <tr class="table-active">
                                <td><strong>Subtotal:</strong></td>
                                <td class="text-right">
                                    <t t-esc="(shipment.shipping_cost or 0) + (shipment.total_broker_fees or 0)"/> EGP
                                </td>
                            </tr>
                            <tr class="text-success">
                                <td>
                                    <strong>Discount
                                        <t t-if="discount_pct">
                                            (<t t-esc="discount_pct"/>%)
                                        </t>:
                                    </strong>
                                </td>
                                <td class="text-right">-<t t-esc="'%.1f' % discount_amt"/> EGP</td>
                            </tr>
                        </t>

                        <tr class="table-warning">
                            <td><h5 class="mb-0"><strong>Total to Pay:</strong></h5></td>
                            <td class="text-right">
                                <h5 class="pricing-total mb-0">
                                    <!-- Calculate total safely -->
                                    <t t-set="total" t-value="shipment.calculated_customer_price or 0"/>
                                    <t t-esc="total"/> EGP
                                </h5>
                            </td>
                        </tr>
                    </table>
                </t>
                <!-- Show only total if no confirmed invoice -->
                <t t-else="">
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle mr-2"></i>
                        Detailed pricing will be available after invoice confirmation
                    </div>
                    <table class="table table-sm">
                        <tr class="table-warning">
                            <td><h5 class="mb-0"><strong>Estimated Total:</strong></h5></td>
                            <td class="text-right">
                                <h5 class="pricing-total mb-0">
                                    <t t-esc="shipment.final_customer_price or 0"/> EGP
                                </h5>
                            </td>
                        </tr>
                    </table>
                </t>

                <t t-if="shipment.payment_method == 'cod' and shipment.cod_amount">
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="fa fa-money mr-2"></i>
                        <strong>COD Amount:</strong> <t t-esc="shipment.cod_amount"/> EGP
                    </div>
                </t>
            </div>
        </div>
    </div>
</div>

                <!-- Notes -->
                <t t-if="shipment.notes">
                    <div class="card shipment-info-card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fa fa-comment mr-2"></i>Additional Notes
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-0"><t t-esc="shipment.notes"/></p>
                        </div>
                    </div>
                </t>

                <!-- Action Buttons -->
                <div class="portal-action-buttons text-center">
                    <t t-if="shipment.tracking_number">
                        <a t-att-href="'/shipment/track?tracking=%s' % shipment.tracking_number"
                           class="btn btn-primary">
                            <i class="fa fa-search"></i> Track Shipment
                        </a>
                    </t>
                    <a href="/shipment" class="btn btn-success">
                        <i class="fa fa-plus"></i> New Shipment
                    </a>
                    <a href="/my/shipments" class="btn btn-secondary">
                        <i class="fa fa-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>
        </t>
    </template>


    <template id="portal_my_invoices" name="My Invoices Dashboard">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <!-- Include CSS -->
            <link rel="stylesheet" href="/shipping_management_system/static/src/css/invoice_dashboard.css"/>

            <!-- Main Dashboard Section -->
            <div class="invoice-dashboard-container">
                <!-- Header Section -->
                <div class="dashboard-header">
                    <div class="container">
                        <div class="header-content">
                            <h1 class="dashboard-title">
                                <i class="fa fa-chart-line"></i>
                                <span>Financial Dashboard</span>
                            </h1>
                            <p class="dashboard-subtitle">Track your invoices and payments</p>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards Section -->
                <div class="dashboard-stats">
                    <div class="container">
                        <div class="row">
                            <!-- Total Invoices Card -->
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="stat-card card-blue">
                                    <div class="card-icon">
                                        <i class="fa fa-file-invoice"></i>
                                    </div>
                                    <div class="card-content">
                                        <h2 class="card-value">
                                            <span class="counter" data-target="invoice_count">
                                                <t t-esc="invoice_count or 0"/>
                                            </span>
                                        </h2>
                                        <p class="card-label">Total Invoices</p>
                                        <span class="card-badge">All Time</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Total Amount Card -->
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="stat-card card-orange">
                                    <div class="card-icon">
                                        <i class="fa fa-wallet"></i>
                                    </div>
                                    <div class="card-content">
                                        <h2 class="card-value">
                                            <span class="counter">
                                                <t t-esc="int(total_amount or 0)"/>
                                            </span>
                                            <small>EGP</small>
                                        </h2>
                                        <p class="card-label">Total Amount</p>
                                        <div class="mini-progress">
                                            <div class="progress-fill" style="width: 100%;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Paid Amount Card -->
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="stat-card card-green">
                                    <div class="card-icon">
                                        <i class="fa fa-check-circle"></i>
                                    </div>
                                    <div class="card-content">
                                        <h2 class="card-value">
                                            <span class="counter">
                                                <t t-esc="int(paid_amount or 0)"/>
                                            </span>
                                            <small>EGP</small>
                                        </h2>
                                        <p class="card-label">Paid Amount</p>
                                        <span class="card-badge badge-success">
                                            <t t-esc="paid_count or 0"/> Invoices
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Unpaid Amount Card -->
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="stat-card card-red">
                                    <div class="card-icon">
                                        <i class="fa fa-clock"></i>
                                    </div>
                                    <div class="card-content">
                                        <h2 class="card-value">
                                            <span class="counter">
                                                <t t-esc="int(unpaid_amount or 0)"/>
                                            </span>
                                            <small>EGP</small>
                                        </h2>
                                        <p class="card-label">Outstanding</p>
                                        <span class="card-badge badge-danger">
                                            <t t-esc="unpaid_count or 0"/> Pending
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Progress Bar -->
                        <div class="payment-progress-section">
                            <h3 class="progress-title">Payment Collection Progress</h3>
                            <div class="payment-progress">
                                <t t-set="paid_percentage" t-value="(paid_amount / total_amount * 100) if total_amount else 0"/>
                                <div class="progress-bar-container">
                                    <div class="progress-bar progress-paid"
                                         t-att-style="'width: ' + str(int(paid_percentage)) + '%;'">
                                        <span class="progress-label">
                                            <i class="fa fa-check"></i>
                                            Collected <t t-esc="int(paid_percentage)"/>%
                                        </span>
                                    </div>
                                    <div class="progress-bar progress-unpaid"
                                         t-att-style="'width: ' + str(int(100 - paid_percentage)) + '%;'">
                                        <span class="progress-label">
                                            <i class="fa fa-clock"></i>
                                            Outstanding <t t-esc="int(100 - paid_percentage)"/>%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions Bar -->
                <div class="actions-section">
                    <div class="container">
                        <div class="actions-bar">
                            <div class="actions-left">
                                <h2 class="section-title">
                                    <i class="fa fa-list"></i> Invoice List
                                </h2>
                            </div>
                            <div class="actions-right">
                                <button class="btn-custom btn-print" onclick="window.print()">
                                    <i class="fa fa-print"></i> Print
                                </button>
                                <button class="btn-custom btn-excel">
                                    <i class="fa fa-file-excel"></i> Export
                                </button>
                                <button class="btn-custom btn-refresh" onclick="location.reload()">
                                    <i class="fa fa-sync"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="container">
                    <t t-call="portal.portal_searchbar">
                        <t t-set="title">Search Invoices</t>
                    </t>
                </div>

                <!-- Invoices Table -->
                <div class="container">
                    <div class="invoice-table-container">
                        <t t-if="not invoices">
                            <div class="empty-state">
                                <i class="fa fa-inbox"></i>
                                <h3>No Invoices Found</h3>
                                <p>You don't have any invoices at the moment</p>
                                <a href="/my/shipments" class="btn-custom btn-primary">
                                    <i class="fa fa-truck"></i> View Shipments
                                </a>
                            </div>
                        </t>

                        <t t-if="invoices">
                            <div class="table-wrapper">
                                <table class="invoice-table">
                                    <thead>
                                        <tr>
                                            <th>Invoice #</th>
                                            <th>Date</th>
                                            <th>Due Date</th>
                                            <th>Shipment</th>
                                            <th>Status</th>
                                            <th>Amount</th>
                                            <th>Balance</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="invoices" t-as="invoice">
                                            <tr class="table-row">
                                                <td class="invoice-number">
                                                    <a t-att-href="'/my/invoice/%s' % invoice.id">
                                                        <i class="fa fa-file-text"></i>
                                                        <t t-esc="invoice.name"/>
                                                    </a>
                                                </td>
                                                <td>
                                                    <span class="date-badge">
                                                        <t t-esc="invoice.invoice_date" t-options='{"widget": "date"}'/>
                                                    </span>
                                                </td>
                                                <td>
                                                    <t t-if="invoice.invoice_date_due">
                                                        <span class="date-badge due-date">
                                                            <t t-esc="invoice.invoice_date_due" t-options='{"widget": "date"}'/>
                                                        </span>
                                                    </t>
                                                </td>
                                                <td>
                                                    <t t-if="invoice.shipment_id">
                                                        <a t-att-href="'/my/shipment/%s' % invoice.shipment_id.id"
                                                           class="shipment-link">
                                                            <t t-esc="invoice.shipment_id.order_number"/>
                                                        </a>
                                                    </t>
                                                </td>
                                                <td class="status-cell">
                                                    <t t-if="invoice.state == 'draft'">
                                                        <span class="status-badge status-draft">Draft</span>
                                                    </t>
                                                    <t t-elif="invoice.payment_state == 'paid'">
                                                        <span class="status-badge status-paid">
                                                            <i class="fa fa-check"></i> Paid
                                                        </span>
                                                    </t>
                                                    <t t-elif="invoice.payment_state == 'partial'">
                                                        <span class="status-badge status-partial">Partial</span>
                                                    </t>
                                                    <t t-else="">
                                                        <span class="status-badge status-unpaid">
                                                            <i class="fa fa-exclamation"></i> Unpaid
                                                        </span>
                                                    </t>
                                                </td>
                                                <td class="amount-cell">
                                                    <strong><t t-esc="int(invoice.amount_total)"/> EGP</strong>
                                                </td>
                                                <td class="balance-cell">
                                                    <t t-if="invoice.amount_residual > 0">
                                                        <span class="amount-danger">
                                                            <t t-esc="int(invoice.amount_residual)"/> EGP
                                                        </span>
                                                    </t>
                                                    <t t-else="">
                                                        <span class="amount-success">
                                                            <i class="fa fa-check"></i> Settled
                                                        </span>
                                                    </t>
                                                </td>
                                                <td class="actions-cell">
                                                    <div class="action-buttons">
                                                        <a t-att-href="'/my/invoice/%s' % invoice.id"
                                                           class="btn-action btn-view" title="View">
                                                            <i class="fa fa-eye"></i>
                                                        </a>
                                                        <button class="btn-action btn-download" title="Download">
                                                            <i class="fa fa-download"></i>
                                                        </button>
                                                        <t t-if="invoice.payment_state != 'paid'">
                                                            <button class="btn-action btn-pay" title="Pay Now">
                                                                <i class="fa fa-credit-card"></i>
                                                            </button>
                                                        </t>
                                                    </div>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </t>
                    </div>
                </div>
            </div>

            <!-- JavaScript for Counter Animation -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Animate counters
                    const counters = document.querySelectorAll('.counter');
                    counters.forEach(counter => {
                        const target = parseInt(counter.innerText);
                        let count = 0;
                        const increment = target / 50;

                        const updateCounter = () => {
                            if (count &lt; target) {
                                count += increment;
                                counter.innerText = Math.ceil(count);
                                requestAnimationFrame(updateCounter);
                            } else {
                                counter.innerText = target;
                            }
                        };
                        updateCounter();
                    });
                });
            </script>
        </t>
    </template>

<!-- Invoice Detail View -->
<template id="portal_my_invoice_detail" name="Invoice Detail">
    <t t-call="portal.portal_layout">
        <div class="container mt-4">
            <!-- Invoice Header -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="row">
                        <div class="col-md-6">
                            <h3 class="mb-0">
                                <i class="fa fa-file-text-o mr-2"></i>
                                Invoice: <t t-esc="invoice.name"/>
                            </h3>
                        </div>
                        <div class="col-md-6 text-right">
                            <t t-if="invoice.state == 'draft'">
                                <span class="badge badge-light h5">Draft</span>
                            </t>
                            <t t-elif="invoice.payment_state == 'paid'">
                                <span class="badge badge-success h5">
                                    <i class="fa fa-check-circle"></i> Paid
                                </span>
                            </t>
                            <t t-else="">
                                <span class="badge badge-danger h5">
                                    <i class="fa fa-exclamation-circle"></i> Unpaid
                                </span>
                            </t>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Invoice Info -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Invoice Details</h5>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Invoice Date:</strong></td>
                                    <td><t t-esc="invoice.invoice_date" t-options='{"widget": "date"}'/></td>
                                </tr>
                                <tr>
                                    <td><strong>Due Date:</strong></td>
                                    <td>
                                        <t t-if="invoice.invoice_date_due">
                                            <span t-field="invoice.invoice_date_due" t-options='{"widget": "date"}'/>
                                        </t>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Related Shipment:</strong></td>
                                    <td>
                                        <t t-if="invoice.shipment_id">
                                            <a t-att-href="'/my/shipment/%s' % invoice.shipment_id.id">
                                                <t t-esc="invoice.shipment_id.order_number"/>
                                            </a>
                                        </t>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>Payment Information</h5>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Total Amount:</strong></td>
                                    <td class="text-right">
                                        <span class="h5"><t t-esc="'%.2f' % invoice.amount_total"/> EGP</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Paid Amount:</strong></td>
                                    <td class="text-right">
                                        <t t-esc="'%.2f' % (invoice.amount_total - invoice.amount_residual)"/> EGP
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Balance Due:</strong></td>
                                    <td class="text-right">
                                        <span class="h5 text-danger">
                                            <t t-esc="'%.2f' % invoice.amount_residual"/> EGP
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Invoice Lines -->
                    <h5>Invoice Items</h5>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-right">Unit Price</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="invoice.invoice_line_ids" t-as="line">
                                <tr>
                                    <td><t t-esc="line.name"/></td>
                                    <td class="text-center"><t t-esc="line.quantity"/></td>
                                    <td class="text-right"><t t-esc="'%.2f' % line.price_unit"/> EGP</td>
                                    <td class="text-right"><t t-esc="'%.2f' % line.price_subtotal"/> EGP</td>
                                </tr>
                            </t>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-right"><strong>Total:</strong></td>
                                <td class="text-right">
                                    <strong class="h5"><t t-esc="'%.2f' % invoice.amount_total"/> EGP</strong>
                                </td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Action Buttons -->
                    <div class="text-center mt-4">
                        <t t-if="invoice.payment_state != 'paid'">
                            <button class="btn btn-success btn-lg">
                                <i class="fa fa-credit-card"></i> Pay Now
                            </button>
                        </t>
                        <a t-att-href="'/my/invoices/pdf/%s' % invoice.id" class="btn btn-secondary btn-lg">
                            <i class="fa fa-download"></i> Download PDF
                        </a>
                        <a href="/my/invoices" class="btn btn-outline-primary btn-lg">
                            <i class="fa fa-arrow-left"></i> Back to Invoices
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </t>
</template>
</odoo>