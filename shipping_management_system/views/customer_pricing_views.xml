<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- تعديل Form View للشحنة لإضافة زر إنشاء فاتورة -->
    <record id="view_shipment_order_form_invoice" model="ir.ui.view">
        <field name="name">shipment.order.form.invoice</field>
        <field name="model">shipment.order</field>
        <field name="inherit_id" ref="shipping_management_system.view_shipment_order_form"/>
        <field name="arch" type="xml">

            <!-- إضافة زر Create Invoice في الهيدر -->
            <button name="action_confirm" position="after">
                <button name="action_create_invoice"
                        string="Create Invoice"
                        type="object"
                        class="btn-primary"
                        invisible="state in ['draft', 'cancelled'] or invoice_status == 'invoiced'"
                        confirm="Are you sure you want to create an invoice for this shipment?"
                        icon="fa-file-invoice-dollar"/>
            </button>

            <!-- تعديل Smart Button للفواتير ليعمل بشكل صحيح -->
            <xpath expr="//button[@name='action_view_invoices']" position="replace">
                <button class="oe_stat_button"
                        type="object"
                        name="action_view_invoices"
                        icon="fa-file-text-o">
                    <field name="invoice_count" widget="statinfo" string="Invoices"/>
                </button>
            </xpath>

            <!-- إضافة حقل invoice_status -->
            <field name="state" position="after">
                <field name="invoice_status"
                       widget="badge"
                       decoration-success="invoice_status == 'invoiced'"
                       decoration-warning="invoice_status == 'to_invoice'"
                       decoration-muted="invoice_status == 'no_invoice'"/>
            </field>

        </field>
    </record>

    <!-- تعديل List View للشحنات لإضافة حالة الفاتورة -->
    <record id="view_shipment_order_list_invoice" model="ir.ui.view">
        <field name="name">shipment.order.list.invoice</field>
        <field name="model">shipment.order</field>
        <field name="inherit_id" ref="shipping_management_system.view_shipment_order_list"/>
        <field name="arch" type="xml">

            <field name="state" position="after">
                <field name="invoice_status"
                       widget="badge"
                       decoration-success="invoice_status == 'invoiced'"
                       decoration-warning="invoice_status == 'to_invoice'"
                       decoration-muted="invoice_status == 'no_invoice'"
                       optional="show"/>
                <field name="invoice_count"
                       string="Inv"
                       optional="hide"/>
            </field>

        </field>
    </record>

    <!-- تعديل Search View لإضافة فلاتر الفواتير -->
    <record id="view_shipment_order_search_invoice" model="ir.ui.view">
        <field name="name">shipment.order.search.invoice</field>
        <field name="model">shipment.order</field>
        <field name="inherit_id" ref="shipping_management_system.view_shipment_order_search"/>
        <field name="arch" type="xml">

            <filter name="delivered" position="after">
                <separator/>
                <filter name="to_invoice"
                        string="To Invoice"
                        domain="[('invoice_status', '=', 'to_invoice')]"
                        help="Shipments ready to be invoiced"/>
                <filter name="invoiced"
                        string="Invoiced"
                        domain="[('invoice_status', '=', 'invoiced')]"
                        help="Shipments with invoices"/>
                <filter name="not_invoiced"
                        string="Not Invoiced"
                        domain="[('invoice_status', '=', 'no_invoice')]"
                        help="Shipments without invoices"/>
            </filter>

            <filter name="state" position="after">
                <filter name="invoice_status"
                        string="Invoice Status"
                        context="{'group_by': 'invoice_status'}"/>
            </filter>

        </field>
    </record>

    <!-- تعديل Form View للفاتورة لإضافة معلومات الشحنة -->
    <record id="view_move_form_shipment" model="ir.ui.view">
        <field name="name">account.move.form.shipment</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">

            <!-- إضافة حقول الشحنة في معلومات الفاتورة -->
            <field name="ref" position="after">
                <field name="shipment_id"
                       invisible="move_type != 'out_invoice'"
                       readonly="1"
                       context="{'form_view_ref': 'shipping_management_system.view_shipment_order_form'}"/>
                <field name="tracking_number"
                       invisible="not shipment_id"
                       readonly="1"/>
                <field name="shipping_company"
                       invisible="not shipment_id"
                       readonly="1"/>
            </field>

        </field>
    </record>

    <!-- Action لإنشاء فاتورة من الشحنة -->
    <record id="action_create_invoice_from_shipment" model="ir.actions.server">
        <field name="name">Create Invoice</field>
        <field name="model_id" ref="shipping_management_system.model_shipment_order"/>
        <field name="binding_model_id" ref="shipping_management_system.model_shipment_order"/>
        <field name="state">code</field>
        <field name="code">
if records:
    for record in records:
        if record.state not in ['draft', 'cancelled'] and record.invoice_status != 'invoiced':
            record.action_create_invoice()
        </field>
    </record>

    <!-- Server Action لإنشاء فواتير متعددة -->
    <record id="action_create_multiple_invoices" model="ir.actions.server">
        <field name="name">Create Invoices (Batch)</field>
        <field name="model_id" ref="shipping_management_system.model_shipment_order"/>
        <field name="binding_model_id" ref="shipping_management_system.model_shipment_order"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
invoices_created = 0
errors = []

for record in records:
    try:
        if record.state not in ['draft', 'cancelled'] and record.invoice_status != 'invoiced':
            record.action_create_invoice()
            invoices_created += 1
    except Exception as e:
        errors.append(f"Shipment {record.order_number}: {str(e)}")

if invoices_created > 0:
    message = f"Successfully created {invoices_created} invoice(s)"
    if errors:
        message += f"\n\nErrors:\n" + "\n".join(errors)

    action = {
        'type': 'ir.actions.client',
        'tag': 'display_notification',
        'params': {
            'title': 'Batch Invoice Creation',
            'message': message,
            'type': 'success' if not errors else 'warning',
            'sticky': True if errors else False,
        }
    }
else:
    action = {
        'type': 'ir.actions.client',
        'tag': 'display_notification',
        'params': {
            'title': 'No Invoices Created',
            'message': 'No eligible shipments found for invoice creation',
            'type': 'warning',
        }
    }
        </field>
    </record>

</odoo>