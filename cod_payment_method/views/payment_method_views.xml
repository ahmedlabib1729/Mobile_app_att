<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- تعديل فورم Payment Method -->
    <record id="payment_method_form_cod" model="ir.ui.view">
        <field name="name">payment.method.form.cod</field>
        <field name="model">payment.method</field>
        <field name="inherit_id" ref="payment.payment_method_form"/>
        <field name="arch" type="xml">
            <!-- إضافة الحقل المحسوب -->
            <xpath expr="//form" position="inside">
                <field name="is_cod_method" invisible="1"/>
            </xpath>
            <xpath expr="//sheet" position="inside">
                <notebook invisible="not is_cod_method">
                    <page string="COD Configuration" name="cod_config">
                        <group>
                            <group string="Available Countries">
                                <field name="cod_country_ids" widget="many2many_tags" options="{'no_create': True}">
                                    <tree>
                                        <field name="name"/>
                                        <field name="code"/>
                                    </tree>
                                </field>
                                <div class="text-muted">
                                    Leave empty to allow COD in all countries
                                </div>
                            </group>
                        </group>
                        <group string="Country-Specific Fees">
                            <field name="cod_fee_by_country"/>
                            <field name="cod_country_fee_ids" invisible="not cod_fee_by_country" context="{'default_payment_method_id': id}">
                                <tree editable="bottom">
                                    <field name="country_id" options="{'no_create': True}"/>
                                    <field name="fee_type"/>
                                    <field name="fee_amount"/>
                                    <field name="currency_id" groups="base.group_multi_currency"/>
                                    <field name="active"/>
                                </tree>
                            </field>
                        </group>
                    </page>
                </notebook>
            </xpath>
        </field>
    </record>

    <!-- Form view for Payment Method Country Fee -->
    <record id="payment_method_country_fee_form" model="ir.ui.view">
        <field name="name">payment.method.country.fee.form</field>
        <field name="model">payment.method.country.fee</field>
        <field name="arch" type="xml">
            <form string="COD Country Fee">
                <sheet>
                    <group>
                        <group>
                            <field name="payment_method_id" readonly="1"/>
                            <field name="country_id" options="{'no_create': True}"/>
                            <field name="fee_type"/>
                            <field name="fee_amount"/>
                        </group>
                        <group>
                            <field name="currency_id" groups="base.group_multi_currency"/>
                            <field name="active"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Tree view for Payment Method Country Fee -->
    <record id="payment_method_country_fee_tree" model="ir.ui.view">
        <field name="name">payment.method.country.fee.tree</field>
        <field name="model">payment.method.country.fee</field>
        <field name="arch" type="xml">
            <tree string="COD Country Fees">
                <field name="country_id"/>
                <field name="fee_type"/>
                <field name="fee_amount"/>
                <field name="currency_id" groups="base.group_multi_currency"/>
                <field name="active"/>
            </tree>
        </field>
    </record>

    <!-- Search view for Payment Method Country Fee -->
    <record id="payment_method_country_fee_search" model="ir.ui.view">
        <field name="name">payment.method.country.fee.search</field>
        <field name="model">payment.method.country.fee</field>
        <field name="arch" type="xml">
            <search string="Search COD Country Fees">
                <field name="country_id"/>
                <field name="payment_method_id"/>
                <filter string="Active" name="active" domain="[('active', '=', True)]"/>
                <filter string="Inactive" name="inactive" domain="[('active', '=', False)]"/>
                <separator/>
                <filter string="Fixed Fee" name="fixed" domain="[('fee_type', '=', 'fixed')]"/>
                <filter string="Percentage Fee" name="percent" domain="[('fee_type', '=', 'percent')]"/>
                <group expand="0" string="Group By">
                    <filter string="Country" name="country" context="{'group_by': 'country_id'}"/>
                    <filter string="Fee Type" name="fee_type" context="{'group_by': 'fee_type'}"/>
                    <filter string="Payment Method" name="payment_method" context="{'group_by': 'payment_method_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action for Payment Method Country Fee -->
    <record id="action_payment_method_country_fee" model="ir.actions.act_window">
        <field name="name">COD Country Fees</field>
        <field name="res_model">payment.method.country.fee</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="payment_method_country_fee_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Configure COD fees for different countries
            </p>
        </field>
    </record>



    <!-- Menu item -->
    <menuitem id="menu_payment_method_country_fee"
              name="COD Country Fees"
              parent="sale.menu_sale_config"
              action="action_payment_method_country_fee"
              groups="sales_team.group_sale_manager"
              sequence="100"/>
</odoo>