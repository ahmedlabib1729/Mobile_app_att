<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="accounting_reports.GeneralLedger">
        <div class="o_action">
            <div class="ar-report">
                <!-- Loading -->
                <div t-if="state.isLoading" class="ar-loading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <div t-else="" class="ar-report-container">
                    <!-- Header -->
                    <div class="ar-header">
                        <h2 class="ar-header-title">
                            <i class="fa fa-book me-2"/>
                            General Ledger
                        </h2>
                    </div>

                    <!-- Filters -->
                    <div class="ar-filters">
                        <!-- Date Range -->
                        <div class="ar-filter-row">
                            <span class="ar-filter-label">
                                <i class="fa fa-calendar"/>
                                Date From
                            </span>
                            <input type="date" 
                                   class="ar-date-input"
                                   t-att-value="state.dateFrom"
                                   t-on-change="onChangeDateFrom"/>
                            
                            <span class="ar-filter-label">To</span>
                            <input type="date" 
                                   class="ar-date-input"
                                   t-att-value="state.dateTo"
                                   t-on-change="onChangeDateTo"/>

                            <label class="ar-checkbox">
                                <input type="checkbox"
                                       t-att-checked="state.postedOnly"
                                       t-on-change="onChangePostedOnly"/>
                                <span>Posted Only</span>
                            </label>
                        </div>

                        <!-- Account Search Filter -->
                        <div class="ar-filter-row">
                            <span class="ar-filter-label">
                                <i class="fa fa-list"/>
                                Accounts
                            </span>
                            <div class="gl-account-search-wrapper">
                                <!-- Selected Accounts Tags -->
                                <div class="gl-account-search-container">
                                    <t t-foreach="state.selectedAccounts" t-as="account" t-key="account.id">
                                        <span class="gl-account-tag">
                                            [<t t-esc="account.code"/>] <t t-esc="account.name"/>
                                            <i class="fa fa-times" t-on-click.stop="() => this.removeAccount(account.id)"/>
                                        </span>
                                    </t>
                                    <!-- Search Input -->
                                    <input type="text"
                                           class="gl-account-search-input"
                                           placeholder="Search accounts..."
                                           t-att-value="state.accountSearch"
                                           t-on-input="onAccountSearchInput"
                                           t-on-focus="onAccountSearchFocus"
                                           t-on-blur="onAccountSearchBlur"/>
                                </div>
                                <!-- Dropdown Results -->
                                <div t-if="state.showAccountDropdown" class="gl-account-dropdown">
                                    <t t-foreach="state.filteredAccounts" t-as="account" t-key="account.id">
                                        <div class="gl-account-dropdown-item" t-on-click.stop="() => this.selectAccount(account)">
                                            <span class="gl-dropdown-code">[<t t-esc="account.code"/>]</span>
                                            <span class="gl-dropdown-name" t-esc="account.name"/>
                                        </div>
                                    </t>
                                </div>
                                <!-- Clear All Button -->
                                <button t-if="state.selectedAccounts.length > 0" 
                                        class="gl-clear-accounts-btn" 
                                        t-on-click="clearAllAccounts"
                                        title="Clear all accounts">
                                    <i class="fa fa-trash"/>
                                </button>
                            </div>
                        </div>

                        <!-- Journal Filter -->
                        <div class="ar-filter-row">
                            <span class="ar-filter-label">
                                <i class="fa fa-book"/>
                                Journals
                            </span>
                            <select class="ar-select" multiple="multiple" t-on-change="onChangeJournal" style="height: 80px;">
                                <t t-foreach="state.journals" t-as="journal" t-key="journal.id">
                                    <option t-att-value="journal.id">
                                        <t t-esc="journal.name"/>
                                    </option>
                                </t>
                            </select>
                        </div>

                        <!-- Actions -->
                        <div class="ar-filter-row">
                            <button class="ar-btn ar-btn-primary" t-on-click="onRefresh">
                                <i class="fa fa-refresh"/> Refresh
                            </button>
                            <button class="ar-btn ar-btn-success" t-on-click="onExportExcel">
                                <i class="fa fa-file-excel-o"/> Export
                            </button>
                            <button class="ar-btn ar-btn-secondary" t-on-click="onPrint">
                                <i class="fa fa-print"/> Print
                            </button>
                            <button class="ar-btn ar-btn-info" t-on-click="expandAll">
                                <i class="fa fa-expand"/> Expand All
                            </button>
                            <button class="ar-btn ar-btn-secondary" t-on-click="collapseAll">
                                <i class="fa fa-compress"/> Collapse
                            </button>
                        </div>
                    </div>

                    <!-- KPI Cards -->
                    <div class="ar-kpi-row">
                        <div class="ar-kpi-card">
                            <div class="ar-kpi-icon">üìä</div>
                            <div class="ar-kpi-content">
                                <div class="ar-kpi-value" t-esc="formatNumber(state.totalOpening)"/>
                                <div class="ar-kpi-label">Opening Balance</div>
                            </div>
                        </div>
                        <div class="ar-kpi-card kpi-debit">
                            <div class="ar-kpi-icon">üìà</div>
                            <div class="ar-kpi-content">
                                <div class="ar-kpi-value" t-esc="formatNumber(state.totalDebit)"/>
                                <div class="ar-kpi-label">Total Debit</div>
                            </div>
                        </div>
                        <div class="ar-kpi-card kpi-credit">
                            <div class="ar-kpi-icon">üìâ</div>
                            <div class="ar-kpi-content">
                                <div class="ar-kpi-value" t-esc="formatNumber(state.totalCredit)"/>
                                <div class="ar-kpi-label">Total Credit</div>
                            </div>
                        </div>
                        <div class="ar-kpi-card kpi-balance">
                            <div class="ar-kpi-icon">‚öñÔ∏è</div>
                            <div class="ar-kpi-content">
                                <div class="ar-kpi-value" t-esc="formatNumber(state.totalBalance)"/>
                                <div class="ar-kpi-label">Closing Balance</div>
                            </div>
                        </div>
                    </div>

                    <!-- Report Table -->
                    <div class="gl-table-container">
                        <table class="gl-table">
                            <thead>
                                <tr>
                                    <th class="gl-col-expand" style="width: 40px;"/>
                                    <th class="gl-col-account">Account / Entry</th>
                                    <th class="gl-col-date">Date</th>
                                    <th class="gl-col-ref">Reference</th>
                                    <th class="gl-col-partner">Partner</th>
                                    <th class="gl-col-label">Label</th>
                                    <th class="gl-col-amount">Debit</th>
                                    <th class="gl-col-amount">Credit</th>
                                    <th class="gl-col-amount">Balance</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Empty State -->
                                <tr t-if="!state.reportData.accounts || !state.reportData.accounts.length">
                                    <td colspan="9">
                                        <div class="gl-empty-state">
                                            <i class="fa fa-inbox"/>
                                            <h4>No Data Found</h4>
                                            <p>No journal entries found for the selected filters.</p>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Account Rows -->
                                <t t-foreach="state.reportData.accounts || []" t-as="account" t-key="account.id">
                                    <!-- Account Header -->
                                    <tr class="gl-row-account" t-on-click="() => this.toggleAccount(account.id)">
                                        <td class="gl-col-expand">
                                            <span class="gl-toggle-icon">
                                                <i t-att-class="'fa ' + (isAccountExpanded(account.id) ? 'fa-chevron-down' : 'fa-chevron-right')"/>
                                            </span>
                                        </td>
                                        <td class="gl-col-account">
                                            <span class="gl-account-code" t-esc="account.code"/>
                                            <span class="gl-account-name" t-esc="account.name"/>
                                        </td>
                                        <td/>
                                        <td/>
                                        <td/>
                                        <td/>
                                        <td class="gl-col-amount gl-amount-debit" t-esc="formatNumber(account.debit)"/>
                                        <td class="gl-col-amount gl-amount-credit" t-esc="formatNumber(account.credit)"/>
                                        <td class="gl-col-amount gl-amount-balance" t-att-class="account.balance >= 0 ? 'gl-amount-positive' : 'gl-amount-negative'" t-esc="formatNumber(account.balance)"/>
                                    </tr>

                                    <!-- Expanded Content -->
                                    <t t-if="isAccountExpanded(account.id)">
                                        <!-- Opening Balance -->
                                        <tr class="gl-row-opening">
                                            <td/>
                                            <td class="gl-opening-label" colspan="5">
                                                <span class="gl-indent"/>
                                                üìÇ Opening Balance
                                            </td>
                                            <td class="gl-col-amount">-</td>
                                            <td class="gl-col-amount">-</td>
                                            <td class="gl-col-amount gl-amount-balance" t-att-class="account.opening >= 0 ? 'gl-amount-positive' : 'gl-amount-negative'" t-esc="formatNumber(account.opening)"/>
                                        </tr>

                                        <!-- Move Lines -->
                                        <t t-foreach="account.moves || []" t-as="move" t-key="move.id">
                                            <!-- Main Move Row -->
                                            <tr class="gl-row-move" t-att-class="isMoveExpanded(move.move_id) ? 'gl-row-move-expanded' : ''">
                                                <td class="gl-col-expand">
                                                    <span class="gl-move-toggle" t-on-click.stop="() => this.toggleMove(move.move_id)">
                                                        <i t-if="isMoveLoading(move.move_id)" class="fa fa-spinner fa-spin"/>
                                                        <i t-else="" t-att-class="'fa ' + (isMoveExpanded(move.move_id) ? 'fa-minus-square-o' : 'fa-plus-square-o')"/>
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="gl-indent"/>
                                                    <span class="gl-journal-badge" t-esc="move.journal_code"/>
                                                </td>
                                                <td class="gl-col-date" t-esc="move.date"/>
                                                <td class="gl-col-ref">
                                                    <a class="gl-move-ref" t-on-click.stop="() => this.openMove(move.move_id)">
                                                        <t t-esc="move.move_name"/>
                                                    </a>
                                                </td>
                                                <td class="gl-col-partner">
                                                    <span class="gl-partner-name" t-esc="move.partner || '-'"/>
                                                </td>
                                                <td class="gl-col-label">
                                                    <span class="gl-label" t-esc="move.label || move.ref || '-'"/>
                                                </td>
                                                <td class="gl-col-amount">
                                                    <t t-if="move.debit">
                                                        <span class="gl-amount-debit" t-esc="formatNumber(move.debit)"/>
                                                    </t>
                                                    <t t-else="">-</t>
                                                </td>
                                                <td class="gl-col-amount">
                                                    <t t-if="move.credit">
                                                        <span class="gl-amount-credit" t-esc="formatNumber(move.credit)"/>
                                                    </t>
                                                    <t t-else="">-</t>
                                                </td>
                                                <td class="gl-col-amount gl-amount-balance" t-att-class="move.balance >= 0 ? 'gl-amount-positive' : 'gl-amount-negative'" t-esc="formatNumber(move.balance)"/>
                                            </tr>

                                            <!-- Expanded Move Details -->
                                            <t t-if="isMoveExpanded(move.move_id) and getMoveDetails(move.move_id)">
                                                <tr class="gl-row-move-details-header">
                                                    <td colspan="9">
                                                        <div class="gl-move-details-title">
                                                            <i class="fa fa-file-text-o me-2"/>
                                                            Journal Entry Lines - <strong t-esc="getMoveDetails(move.move_id).move_name"/>
                                                            <span class="gl-move-state" t-att-class="getMoveDetails(move.move_id).state === 'posted' ? 'state-posted' : 'state-draft'">
                                                                <t t-esc="getMoveDetails(move.move_id).state === 'posted' ? 'Posted' : 'Draft'"/>
                                                            </span>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <t t-foreach="getMoveDetails(move.move_id).lines || []" t-as="line" t-key="line.id">
                                                    <tr t-att-class="'gl-row-move-detail ' + (line.is_balancing ? 'gl-row-balancing-line' : '')">
                                                        <td/>
                                                        <td class="gl-detail-account">
                                                            <span class="gl-detail-indent"/>
                                                            <span class="gl-detail-code">[<t t-esc="line.account_code"/>]</span>
                                                            <span t-esc="line.account_name"/>
                                                            <span t-if="line.is_balancing" class="gl-balancing-badge">
                                                                <i class="fa fa-check-circle"/> Balanced
                                                            </span>
                                                        </td>
                                                        <td/>
                                                        <td class="gl-detail-partner" t-esc="line.partner || '-'"/>
                                                        <td class="gl-detail-label" t-esc="line.label || '-'"/>
                                                        <td/>
                                                        <td class="gl-col-amount">
                                                            <t t-if="line.debit">
                                                                <span class="gl-detail-debit" t-esc="formatNumber(line.debit)"/>
                                                            </t>
                                                            <t t-else="">-</t>
                                                        </td>
                                                        <td class="gl-col-amount">
                                                            <t t-if="line.credit">
                                                                <span class="gl-detail-credit" t-esc="formatNumber(line.credit)"/>
                                                            </t>
                                                            <t t-else="">-</t>
                                                        </td>
                                                        <td class="gl-col-amount">
                                                            <span t-att-class="(line.is_balancing ? 'gl-detail-balance-zero' : (line.balance >= 0 ? 'gl-detail-balance-positive' : 'gl-detail-balance-negative'))" 
                                                                  t-esc="formatNumber(line.balance)"/>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </t>
                                        </t>

                                        <!-- Closing Balance -->
                                        <tr class="gl-row-closing">
                                            <td/>
                                            <td class="gl-closing-label" colspan="5">
                                                <span class="gl-indent"/>
                                                üìÅ Closing Balance
                                            </td>
                                            <td class="gl-col-amount gl-amount-debit" t-esc="formatNumber(account.debit)"/>
                                            <td class="gl-col-amount gl-amount-credit" t-esc="formatNumber(account.credit)"/>
                                            <td class="gl-col-amount gl-amount-balance" t-att-class="account.balance >= 0 ? 'gl-amount-positive' : 'gl-amount-negative'" t-esc="formatNumber(account.balance)"/>
                                        </tr>
                                    </t>
                                </t>
                            </tbody>

                            <!-- Grand Total -->
                            <tfoot t-if="state.reportData.accounts and state.reportData.accounts.length">
                                <tr class="gl-row-total">
                                    <td/>
                                    <td colspan="5">
                                        <span class="gl-total-icon">üìä</span>
                                        <strong>GRAND TOTAL</strong>
                                    </td>
                                    <td class="gl-col-amount" t-esc="formatNumber(state.reportData.totals.debit || 0)"/>
                                    <td class="gl-col-amount" t-esc="formatNumber(state.reportData.totals.credit || 0)"/>
                                    <td class="gl-col-amount" t-esc="formatNumber(state.reportData.totals.balance || 0)"/>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </t>

</templates>
