<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="accounting_reports.ProfitLoss">
        <div class="o_action">
            <div class="ar-report">
                <div t-if="state.isLoading" class="ar-loading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <div t-else="" class="ar-report-container">
                    <!-- Header -->
                    <div class="ar-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                        <h2 class="ar-header-title">
                            <i class="fa fa-line-chart me-2"/>
                            Profit &amp; Loss Statement
                        </h2>
                        <div class="pl-header-period" t-if="state.reportData.date_from">
                            <span t-esc="state.reportData.date_from"/> - <span t-esc="state.reportData.date_to"/>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="ar-filters">
                        <div class="ar-filter-row">
                            <span class="ar-filter-label">
                                <i class="fa fa-calendar"/>
                                Date From
                            </span>
                            <input type="date" 
                                   class="ar-date-input"
                                   t-att-value="state.dateFrom"
                                   t-on-change="onChangeDateFrom"/>
                            
                            <span class="ar-filter-label">To</span>
                            <input type="date" 
                                   class="ar-date-input"
                                   t-att-value="state.dateTo"
                                   t-on-change="onChangeDateTo"/>

                            <label class="ar-checkbox">
                                <input type="checkbox"
                                       t-att-checked="state.postedOnly"
                                       t-on-change="onChangePostedOnly"/>
                                <span>Posted Only</span>
                            </label>
                        </div>

                        <!-- Comparison Options -->
                        <div class="ar-filter-row">
                            <label class="ar-checkbox">
                                <input type="checkbox"
                                       t-att-checked="state.comparison"
                                       t-on-change="onChangeComparison"/>
                                <span>Compare with:</span>
                            </label>
                            <select class="ar-select" 
                                    t-att-disabled="!state.comparison"
                                    t-on-change="onChangeComparisonType"
                                    style="min-width: 180px;">
                                <option value="previous_period" t-att-selected="state.comparisonType === 'previous_period'">Previous Period</option>
                                <option value="previous_year" t-att-selected="state.comparisonType === 'previous_year'">Same Period Last Year</option>
                            </select>
                            <span class="pl-comp-period" t-if="state.comparison and state.reportData.comp_date_from">
                                (<t t-esc="state.reportData.comp_date_from"/> - <t t-esc="state.reportData.comp_date_to"/>)
                            </span>
                        </div>

                        <!-- Quick Period Buttons -->
                        <div class="ar-filter-row">
                            <span class="ar-filter-label">Quick:</span>
                            <button class="ar-btn ar-btn-outline" t-on-click="() => this.setPeriod('this_month')">This Month</button>
                            <button class="ar-btn ar-btn-outline" t-on-click="() => this.setPeriod('last_month')">Last Month</button>
                            <button class="ar-btn ar-btn-outline" t-on-click="() => this.setPeriod('this_quarter')">This Quarter</button>
                            <button class="ar-btn ar-btn-outline" t-on-click="() => this.setPeriod('this_year')">This Year</button>
                            <button class="ar-btn ar-btn-outline" t-on-click="() => this.setPeriod('last_year')">Last Year</button>
                        </div>

                        <!-- Actions -->
                        <div class="ar-filter-row">
                            <button class="ar-btn ar-btn-primary" t-on-click="onRefresh" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                                <i class="fa fa-refresh"/> Refresh
                            </button>
                            <button class="ar-btn ar-btn-success" t-on-click="onExportExcel">
                                <i class="fa fa-file-excel-o"/> Export
                            </button>
                            <button class="ar-btn ar-btn-secondary" t-on-click="onPrint">
                                <i class="fa fa-print"/> Print
                            </button>
                            <button class="ar-btn ar-btn-info" t-on-click="expandAll">
                                <i class="fa fa-expand"/> Expand All
                            </button>
                            <button class="ar-btn ar-btn-secondary" t-on-click="collapseAll">
                                <i class="fa fa-compress"/> Collapse
                            </button>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="pl-summary">
                        <div class="pl-summary-card income">
                            <div class="pl-card-icon"><i class="fa fa-arrow-up"/></div>
                            <div class="pl-card-content">
                                <span class="pl-card-label">Total Income</span>
                                <span class="pl-card-value" t-esc="formatNumber(state.reportData.summary?.total_income || 0)"/>
                                <span class="pl-card-change" t-if="state.comparison">
                                    vs <t t-esc="formatNumber(state.reportData.summary?.comp_total_income || 0)"/>
                                </span>
                            </div>
                        </div>
                        <div class="pl-summary-card expense">
                            <div class="pl-card-icon"><i class="fa fa-arrow-down"/></div>
                            <div class="pl-card-content">
                                <span class="pl-card-label">Total Expenses</span>
                                <span class="pl-card-value" t-esc="formatNumber(state.reportData.summary?.total_expenses || 0)"/>
                                <span class="pl-card-change" t-if="state.comparison">
                                    vs <t t-esc="formatNumber(state.reportData.summary?.comp_total_expenses || 0)"/>
                                </span>
                            </div>
                        </div>
                        <div class="pl-summary-card gross">
                            <div class="pl-card-icon"><i class="fa fa-calculator"/></div>
                            <div class="pl-card-content">
                                <span class="pl-card-label">Gross Profit</span>
                                <span t-att-class="'pl-card-value ' + getProfitClass(state.reportData.summary?.gross_profit)" 
                                      t-esc="formatNumber(state.reportData.summary?.gross_profit || 0)"/>
                                <span class="pl-card-margin">
                                    <t t-esc="formatPercent(state.reportData.summary?.gross_margin || 0)"/> margin
                                </span>
                            </div>
                        </div>
                        <div t-att-class="'pl-summary-card net ' + getProfitClass(state.reportData.summary?.net_profit)">
                            <div class="pl-card-icon"><i class="fa fa-trophy"/></div>
                            <div class="pl-card-content">
                                <span class="pl-card-label">Net Profit</span>
                                <span class="pl-card-value" t-esc="formatNumber(state.reportData.summary?.net_profit || 0)"/>
                                <span class="pl-card-margin">
                                    <t t-esc="formatPercent(state.reportData.summary?.net_margin || 0)"/> margin
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Report Table -->
                    <div class="pl-table-container">
                        <table class="pl-table">
                            <thead>
                                <tr>
                                    <th class="pl-col-account">Account</th>
                                    <th class="pl-col-amount">Balance</th>
                                    <th class="pl-col-amount" t-if="state.comparison">Comparison</th>
                                    <th class="pl-col-change" t-if="state.comparison">Change</th>
                                    <th class="pl-col-percent">%</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- OPERATING INCOME Section -->
                                <tr class="pl-section-header section-income" t-on-click="() => this.toggleSection('operating_income')">
                                    <td colspan="5">
                                        <span class="pl-section-toggle">
                                            <i t-att-class="'fa ' + (isSectionExpanded('operating_income') ? 'fa-chevron-down' : 'fa-chevron-right')"/>
                                        </span>
                                        <i class="fa fa-arrow-circle-up me-2"/>
                                        Operating Income
                                        <span class="pl-section-total" t-esc="formatNumber(state.reportData.sections?.operating_income?.total || 0)"/>
                                    </td>
                                </tr>
                                <t t-if="isSectionExpanded('operating_income')">
                                    <t t-foreach="state.reportData.sections?.operating_income?.accounts || []" t-as="account" t-key="account.id">
                                        <tr class="pl-account-row" t-on-click="() => this.openAccount(account.id)">
                                            <td class="pl-col-account">
                                                <span class="pl-account-code" t-esc="account.code"/>
                                                <span class="pl-account-name" t-esc="account.name"/>
                                            </td>
                                            <td class="pl-col-amount" t-esc="formatNumber(account.balance)"/>
                                            <td class="pl-col-amount" t-if="state.comparison" t-esc="formatNumber(account.comp_balance)"/>
                                            <td t-if="state.comparison" t-att-class="'pl-col-change ' + getChangeClass(account.change)">
                                                <t t-esc="formatChange(account.change)"/>
                                            </td>
                                            <td class="pl-col-percent">
                                                <t t-if="state.reportData.sections?.operating_income?.total">
                                                    <t t-esc="formatPercent(account.balance / state.reportData.sections.operating_income.total * 100)"/>
                                                </t>
                                            </td>
                                        </tr>
                                    </t>
                                </t>
                                <tr class="pl-section-subtotal section-income">
                                    <td>Total Operating Income</td>
                                    <td class="pl-col-amount" t-esc="formatNumber(state.reportData.sections?.operating_income?.total || 0)"/>
                                    <td class="pl-col-amount" t-if="state.comparison" t-esc="formatNumber(state.reportData.sections?.operating_income?.comp_total || 0)"/>
                                    <td t-if="state.comparison" t-att-class="'pl-col-change ' + getChangeClass(state.reportData.sections?.operating_income?.change)">
                                        <t t-esc="formatChange(state.reportData.sections?.operating_income?.change || 0)"/>
                                    </td>
                                    <td class="pl-col-percent">100%</td>
                                </tr>

                                <!-- COST OF REVENUE Section -->
                                <tr class="pl-section-header section-cogs" t-on-click="() => this.toggleSection('cost_of_revenue')">
                                    <td colspan="5">
                                        <span class="pl-section-toggle">
                                            <i t-att-class="'fa ' + (isSectionExpanded('cost_of_revenue') ? 'fa-chevron-down' : 'fa-chevron-right')"/>
                                        </span>
                                        <i class="fa fa-shopping-cart me-2"/>
                                        Cost of Revenue
                                        <span class="pl-section-total">(<t t-esc="formatNumber(state.reportData.sections?.cost_of_revenue?.total || 0)"/>)</span>
                                    </td>
                                </tr>
                                <t t-if="isSectionExpanded('cost_of_revenue')">
                                    <t t-foreach="state.reportData.sections?.cost_of_revenue?.accounts || []" t-as="account" t-key="account.id">
                                        <tr class="pl-account-row" t-on-click="() => this.openAccount(account.id)">
                                            <td class="pl-col-account">
                                                <span class="pl-account-code" t-esc="account.code"/>
                                                <span class="pl-account-name" t-esc="account.name"/>
                                            </td>
                                            <td class="pl-col-amount pl-expense">(<t t-esc="formatNumber(account.balance)"/>)</td>
                                            <td class="pl-col-amount" t-if="state.comparison">(<t t-esc="formatNumber(account.comp_balance)"/>)</td>
                                            <td t-if="state.comparison" t-att-class="'pl-col-change ' + getChangeClass(-account.change)">
                                                <t t-esc="formatChange(account.change)"/>
                                            </td>
                                            <td class="pl-col-percent">
                                                <t t-if="state.reportData.sections?.operating_income?.total">
                                                    <t t-esc="formatPercent(account.balance / state.reportData.sections.operating_income.total * 100)"/>
                                                </t>
                                            </td>
                                        </tr>
                                    </t>
                                </t>
                                <tr class="pl-section-subtotal section-cogs">
                                    <td>Total Cost of Revenue</td>
                                    <td class="pl-col-amount">(<t t-esc="formatNumber(state.reportData.sections?.cost_of_revenue?.total || 0)"/>)</td>
                                    <td class="pl-col-amount" t-if="state.comparison">(<t t-esc="formatNumber(state.reportData.sections?.cost_of_revenue?.comp_total || 0)"/>)</td>
                                    <td t-if="state.comparison" t-att-class="'pl-col-change ' + getChangeClass(-(state.reportData.sections?.cost_of_revenue?.change || 0))">
                                        <t t-esc="formatChange(state.reportData.sections?.cost_of_revenue?.change || 0)"/>
                                    </td>
                                    <td class="pl-col-percent">
                                        <t t-if="state.reportData.sections?.operating_income?.total">
                                            <t t-esc="formatPercent((state.reportData.sections?.cost_of_revenue?.total || 0) / state.reportData.sections.operating_income.total * 100)"/>
                                        </t>
                                    </td>
                                </tr>

                                <!-- GROSS PROFIT -->
                                <tr class="pl-profit-row gross">
                                    <td><strong><i class="fa fa-calculator me-2"/>GROSS PROFIT</strong></td>
                                    <td t-att-class="'pl-col-amount ' + getProfitClass(state.reportData.summary?.gross_profit)" t-esc="formatNumber(state.reportData.summary?.gross_profit || 0)"/>
                                    <td class="pl-col-amount" t-if="state.comparison" t-esc="formatNumber(state.reportData.summary?.comp_gross_profit || 0)"/>
                                    <td t-if="state.comparison" t-att-class="'pl-col-change ' + getChangeClass((state.reportData.summary?.gross_profit || 0) - (state.reportData.summary?.comp_gross_profit || 0))">
                                        <t t-esc="formatChange((state.reportData.summary?.gross_profit || 0) - (state.reportData.summary?.comp_gross_profit || 0))"/>
                                    </td>
                                    <td class="pl-col-percent pl-margin">
                                        <t t-esc="formatPercent(state.reportData.summary?.gross_margin || 0)"/>
                                    </td>
                                </tr>

                                <!-- OPERATING EXPENSES Section -->
                                <tr class="pl-section-header section-expense" t-on-click="() => this.toggleSection('operating_expenses')">
                                    <td colspan="5">
                                        <span class="pl-section-toggle">
                                            <i t-att-class="'fa ' + (isSectionExpanded('operating_expenses') ? 'fa-chevron-down' : 'fa-chevron-right')"/>
                                        </span>
                                        <i class="fa fa-credit-card me-2"/>
                                        Operating Expenses
                                        <span class="pl-section-total">(<t t-esc="formatNumber(state.reportData.sections?.operating_expenses?.total || 0)"/>)</span>
                                    </td>
                                </tr>
                                <t t-if="isSectionExpanded('operating_expenses')">
                                    <t t-foreach="state.reportData.sections?.operating_expenses?.accounts || []" t-as="account" t-key="account.id">
                                        <tr class="pl-account-row" t-on-click="() => this.openAccount(account.id)">
                                            <td class="pl-col-account">
                                                <span class="pl-account-code" t-esc="account.code"/>
                                                <span class="pl-account-name" t-esc="account.name"/>
                                            </td>
                                            <td class="pl-col-amount pl-expense">(<t t-esc="formatNumber(account.balance)"/>)</td>
                                            <td class="pl-col-amount" t-if="state.comparison">(<t t-esc="formatNumber(account.comp_balance)"/>)</td>
                                            <td t-if="state.comparison" t-att-class="'pl-col-change ' + getChangeClass(-account.change)">
                                                <t t-esc="formatChange(account.change)"/>
                                            </td>
                                            <td class="pl-col-percent">
                                                <t t-if="state.reportData.sections?.operating_income?.total">
                                                    <t t-esc="formatPercent(account.balance / state.reportData.sections.operating_income.total * 100)"/>
                                                </t>
                                            </td>
                                        </tr>
                                    </t>
                                </t>
                                <tr class="pl-section-subtotal section-expense">
                                    <td>Total Operating Expenses</td>
                                    <td class="pl-col-amount">(<t t-esc="formatNumber(state.reportData.sections?.operating_expenses?.total || 0)"/>)</td>
                                    <td class="pl-col-amount" t-if="state.comparison">(<t t-esc="formatNumber(state.reportData.sections?.operating_expenses?.comp_total || 0)"/>)</td>
                                    <td t-if="state.comparison" t-att-class="'pl-col-change ' + getChangeClass(-(state.reportData.sections?.operating_expenses?.change || 0))">
                                        <t t-esc="formatChange(state.reportData.sections?.operating_expenses?.change || 0)"/>
                                    </td>
                                    <td class="pl-col-percent">
                                        <t t-if="state.reportData.sections?.operating_income?.total">
                                            <t t-esc="formatPercent((state.reportData.sections?.operating_expenses?.total || 0) / state.reportData.sections.operating_income.total * 100)"/>
                                        </t>
                                    </td>
                                </tr>

                                <!-- OPERATING PROFIT -->
                                <tr class="pl-profit-row operating">
                                    <td><strong><i class="fa fa-briefcase me-2"/>OPERATING PROFIT</strong></td>
                                    <td t-att-class="'pl-col-amount ' + getProfitClass(state.reportData.summary?.operating_profit)" t-esc="formatNumber(state.reportData.summary?.operating_profit || 0)"/>
                                    <td class="pl-col-amount" t-if="state.comparison" t-esc="formatNumber(state.reportData.summary?.comp_operating_profit || 0)"/>
                                    <td t-if="state.comparison" t-att-class="'pl-col-change ' + getChangeClass((state.reportData.summary?.operating_profit || 0) - (state.reportData.summary?.comp_operating_profit || 0))">
                                        <t t-esc="formatChange((state.reportData.summary?.operating_profit || 0) - (state.reportData.summary?.comp_operating_profit || 0))"/>
                                    </td>
                                    <td class="pl-col-percent"/>
                                </tr>

                                <!-- OTHER INCOME Section -->
                                <tr class="pl-section-header section-other" t-on-click="() => this.toggleSection('other_income')">
                                    <td colspan="5">
                                        <span class="pl-section-toggle">
                                            <i t-att-class="'fa ' + (isSectionExpanded('other_income') ? 'fa-chevron-down' : 'fa-chevron-right')"/>
                                        </span>
                                        <i class="fa fa-plus-circle me-2"/>
                                        Other Income
                                        <span class="pl-section-total" t-esc="formatNumber(state.reportData.sections?.other_income?.total || 0)"/>
                                    </td>
                                </tr>
                                <t t-if="isSectionExpanded('other_income')">
                                    <t t-foreach="state.reportData.sections?.other_income?.accounts || []" t-as="account" t-key="account.id">
                                        <tr class="pl-account-row" t-on-click="() => this.openAccount(account.id)">
                                            <td class="pl-col-account">
                                                <span class="pl-account-code" t-esc="account.code"/>
                                                <span class="pl-account-name" t-esc="account.name"/>
                                            </td>
                                            <td class="pl-col-amount" t-esc="formatNumber(account.balance)"/>
                                            <td class="pl-col-amount" t-if="state.comparison" t-esc="formatNumber(account.comp_balance)"/>
                                            <td t-if="state.comparison" t-att-class="'pl-col-change ' + getChangeClass(account.change)">
                                                <t t-esc="formatChange(account.change)"/>
                                            </td>
                                            <td class="pl-col-percent"/>
                                        </tr>
                                    </t>
                                </t>
                                <tr class="pl-section-subtotal section-other" t-if="state.reportData.sections?.other_income?.accounts?.length">
                                    <td>Total Other Income</td>
                                    <td class="pl-col-amount" t-esc="formatNumber(state.reportData.sections?.other_income?.total || 0)"/>
                                    <td class="pl-col-amount" t-if="state.comparison" t-esc="formatNumber(state.reportData.sections?.other_income?.comp_total || 0)"/>
                                    <td t-if="state.comparison" t-att-class="'pl-col-change ' + getChangeClass(state.reportData.sections?.other_income?.change)">
                                        <t t-esc="formatChange(state.reportData.sections?.other_income?.change || 0)"/>
                                    </td>
                                    <td class="pl-col-percent"/>
                                </tr>
                            </tbody>

                            <!-- NET PROFIT -->
                            <tfoot>
                                <tr t-att-class="'pl-net-profit ' + getProfitClass(state.reportData.summary?.net_profit)">
                                    <td><strong><i class="fa fa-trophy me-2"/>NET PROFIT</strong></td>
                                    <td class="pl-col-amount" t-esc="formatNumber(state.reportData.summary?.net_profit || 0)"/>
                                    <td class="pl-col-amount" t-if="state.comparison" t-esc="formatNumber(state.reportData.summary?.comp_net_profit || 0)"/>
                                    <td t-if="state.comparison" t-att-class="'pl-col-change ' + getChangeClass((state.reportData.summary?.net_profit || 0) - (state.reportData.summary?.comp_net_profit || 0))">
                                        <t t-esc="formatChange((state.reportData.summary?.net_profit || 0) - (state.reportData.summary?.comp_net_profit || 0))"/>
                                    </td>
                                    <td class="pl-col-percent pl-margin">
                                        <t t-esc="formatPercent(state.reportData.summary?.net_margin || 0)"/>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </t>

</templates>
