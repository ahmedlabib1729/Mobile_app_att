<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Define the Customer Payment Receipt report -->
    <record id="action_report_customer_payment_receipt" model="ir.actions.report">
        <field name="name">Customer Payment Receipt</field>
        <field name="model">account.payment</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">custom_invoice_report.report_payment_receipt_document</field>
        <field name="report_file">custom_invoice_report.report_payment_receipt_document</field>
        <field name="binding_model_id" ref="account.model_account_payment"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="base.paperformat_euro"/>
    </record>

    <!-- Main report template -->
    <template id="report_payment_receipt_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-if="o.partner_type == 'customer' and o.payment_type == 'inbound'">
                    <t t-call="custom_invoice_report.report_payment_receipt_layout">
                        <t t-set="o" t-value="o"/>
                    </t>
                </t>
            </t>
        </t>
    </template>

    <!-- Payment Receipt Layout -->
    <template id="report_payment_receipt_layout">
        <div class="article o_report_layout_standard" t-att-data-oe-model="o and o._name" t-att-data-oe-id="o and o.id">
            <t t-set="company" t-value="o.company_id"/>
            
            <style>
                @page {
                    margin: 0mm;
                    size: A4;
                }
                
                body {
                    font-family: 'Arial', sans-serif;
                    font-size: 10pt;
                    line-height: 1.4;
                    margin: 0;
                    padding: 0mm 15mm 15mm 15mm;  /* لا يوجد padding من فوق */
                    color: #000;
                }

                .receipt-container {
                    width: 100%;
                    max-width: 180mm;
                    margin: 0 auto;
                    padding-top: 5mm;  /* مسافة صغيرة جداً من أعلى */
                }

                .company-header {
                    border-bottom: 2px solid #000;
                    padding-bottom: 3mm;
                    margin-bottom: 5mm;
                }

                .company-logo {
                    max-height: 50px;
                    max-width: 200px;
                    margin-bottom: 2mm;
                }

                .company-info {
                    font-size: 9pt;
                    line-height: 1.3;
                    color: #000;
                }

                .receipt-title-section {
                    text-align: center;
                    margin-bottom: 5mm;
                }

                .receipt-title {
                    font-size: 14pt;
                    font-weight: bold;
                    letter-spacing: 1px;
                    margin-bottom: 2mm;
                }

                .reference-number {
                    font-size: 10pt;
                    color: #666;
                }

                .amount-box {
                    float: right;
                    background-color: #5B9BD5;
                    color: white;
                    padding: 8mm 10mm;
                    text-align: center;
                    margin-bottom: 5mm;
                    min-width: 80mm;
                }

                .amount-label {
                    font-size: 9pt;
                    margin-bottom: 2mm;
                }

                .amount-value {
                    font-size: 16pt;
                    font-weight: bold;
                }

                .customer-info {
                    clear: both;
                    margin-bottom: 5mm;
                    padding-top: 5mm;
                }

                .info-row {
                    display: table;
                    width: 100%;
                    margin-bottom: 3mm;
                }

                .info-cell {
                    display: table-cell;
                    vertical-align: top;
                    padding: 2mm 0;
                }

                .info-cell.half {
                    width: 50%;
                }

                .info-label {
                    font-weight: bold;
                    margin-bottom: 1mm;
                }

                .info-value {
                    color: #333;
                }

                .payment-for-section {
                    margin-top: 8mm;
                    margin-bottom: 5mm;
                }

                .section-header {
                    font-weight: bold;
                    margin-bottom: 3mm;
                    font-size: 11pt;
                }

                .invoices-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 8mm;
                    font-size: 10pt;
                }

                .invoices-table th {
                    background-color: #f5f5f5;
                    padding: 3mm 2mm;
                    text-align: left;
                    font-weight: normal;
                    color: #666;
                    font-size: 9pt;
                    border-bottom: 1px solid #ddd;
                }

                .invoices-table td {
                    padding: 3mm 2mm;
                    border-bottom: 1px solid #f5f5f5;
                }

                .invoices-table td.right {
                    text-align: right;
                }

                .invoices-table td.center {
                    text-align: center;
                }

                .authorized-signature {
                    text-align: right;
                    margin-top: 15mm;
                    margin-bottom: 10mm;
                }

                .signature-line {
                    border-top: 1px solid #000;
                    display: inline-block;
                    min-width: 100mm;
                    margin-top: 15mm;
                }

                .signature-section {
                    margin-top: 5mm;
                    border-top: 1px solid #ddd;
                    padding-top: 5mm;
                }

                .signature-row {
                    display: table;
                    width: 100%;
                    margin-bottom: 3mm;
                }

                .signature-cell {
                    display: table-cell;
                    width: 25%;
                    text-align: center;
                    padding: 2mm;
                    vertical-align: top;
                }

                .signature-label {
                    font-weight: bold;
                    font-size: 9pt;
                    border-top: 1px solid #000;
                    padding-top: 2mm;
                    display: inline-block;
                    min-width: 80px;
                }

                .footer-info {
                    text-align: center;
                    font-size: 8pt;
                    color: #666;
                    margin-top: 3mm;
                    padding-top: 3mm;
                    border-top: 1px solid #ddd;
                }

                .page-number {
                    text-align: center;
                    font-size: 8pt;
                    color: #999;
                    margin-top: 2mm;
                }

                .bold {
                    font-weight: bold;
                }
            </style>

            <div class="receipt-container">
                <!-- Company Header with Logo -->
                <div class="company-header">
                    <t t-if="company.logo">
                        <img t-att-src="image_data_uri(company.logo)" class="company-logo" alt="Company Logo"/>
                    </t>
                    <div class="company-info">
                        <div class="bold"><t t-esc="company.name"/></div>
                        <t t-if="company.street">
                            <div><t t-esc="company.street"/></div>
                        </t>
                        <t t-if="company.street2">
                            <div><t t-esc="company.street2"/></div>
                        </t>
                        <t t-if="company.city">
                            <div><t t-esc="company.city"/></div>
                        </t>
                        <t t-if="company.country_id">
                            <div><t t-esc="company.country_id.name"/></div>
                        </t>
                    </div>
                </div>

                <!-- Receipt Title -->
                <div class="receipt-title-section">
                    <div class="receipt-title">CUSTOMER PAYMENT RECEIPT</div>
                    <div class="reference-number">Reference Number: <t t-esc="o.name"/></div>
                </div>

                <!-- Amount Received Box -->
                <div class="amount-box">
                    <div class="amount-label">Amount Received</div>
                    <div class="amount-value"><t t-esc="'{:,.3f}'.format(o.amount)"/> <t t-esc="o.currency_id.name"/></div>
                </div>

                <!-- Customer Information -->
                <div class="customer-info">
                    <div class="info-label">Received From</div>
                    <div class="info-value">
                        <t t-esc="o.partner_id.name"/>
                    </div>
                    <div class="info-value">
                        <t t-if="o.partner_id.street"><t t-esc="o.partner_id.street"/></t>
                    </div>
                    <div class="info-value">
                        <t t-if="o.partner_id.country_id"><t t-esc="o.partner_id.country_id.name"/></t>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="info-row">
                    <div class="info-cell half">
                        <div class="info-label">Payment Date</div>
                        <div class="info-value"><t t-esc="o.date.strftime('%d/%m/%Y') if o.date else ''"/></div>
                    </div>
                    <div class="info-cell half">
                        <div class="info-label">Cheque Date</div>
                        <div class="info-value">
                            <t t-if="o.payment_method_line_id and o.payment_method_line_id.code == 'check_printing'">
                                <t t-esc="o.date.strftime('%d/%m/%Y') if o.date else ''"/>
                            </t>
                        </div>
                    </div>
                </div>

                <div class="info-row">
                    <div class="info-cell half">
                        <div class="info-label">Reference Number</div>
                        <div class="info-value"><t t-esc="o.payment_reference or o.name or ''"/></div>
                    </div>
                    <div class="info-cell half">
                        <div class="info-label">Cheque Number</div>
                        <div class="info-value">
                            <t t-if="o.payment_method_line_id and o.payment_method_line_id.code == 'check_printing'">
                                <t t-esc="o.check_number or ''"/>
                            </t>
                        </div>
                    </div>
                </div>

                <div class="info-row">
                    <div class="info-cell half">
                        <div class="info-label">Payment Mode</div>
                        <div class="info-value">
                            <t t-esc="o.journal_id.name"/>
                            <t t-if="o.journal_id.bank_account_id">
                                (<t t-esc="o.journal_id.bank_account_id.acc_number or ''"/>)
                            </t>
                        </div>
                    </div>
                    <div class="info-cell half">
                        <div class="info-label">Cheque Bank</div>
                        <div class="info-value">
                            <t t-if="o.payment_method_line_id and o.payment_method_line_id.code == 'check_printing'">
                                <t t-if="o.journal_id.bank_id">
                                    <t t-esc="o.journal_id.bank_id.name"/>
                                    <t t-if="o.journal_id.bank_account_id">
                                         - <t t-esc="o.journal_id.bank_account_id.acc_number or ''"/>
                                    </t>
                                </t>
                            </t>
                        </div>
                    </div>
                </div>

                <!-- Payment For Section -->
                <div class="payment-for-section">
                    <div class="section-header">Payment for</div>

                    <table class="invoices-table">
                        <thead>
                            <tr>
                                <th style="width: 15%;">Invoice Number</th>
                                <th style="width: 15%;">Invoice Date</th>
                                <th style="width: 15%; text-align: right;">Invoice Due</th>
                                <th style="width: 15%; text-align: right;">Invoice Amount</th>
                                <th style="width: 15%; text-align: right;">Balance</th>
                                <th style="width: 15%; text-align: right;">Tax Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Get reconciled invoices directly from payment -->
                            <t t-set="invoices" t-value="o.reconciled_invoice_ids"/>

                            <t t-if="invoices">
                                <t t-foreach="invoices" t-as="invoice">
                                    <tr>
                                        <td><t t-esc="invoice.name"/></td>
                                        <td><t t-esc="invoice.invoice_date.strftime('%d/%m/%Y') if invoice.invoice_date else ''"/></td>
                                        <td class="right">
                                            <t t-set="amount_due" t-value="invoice.amount_residual + (invoice.amount_total - invoice.amount_residual)"/>
                                            <t t-esc="'{:,.3f}'.format(amount_due)"/> <t t-esc="invoice.currency_id.name"/>
                                        </td>
                                        <td class="right"><t t-esc="'{:,.3f}'.format(invoice.amount_total)"/> <t t-esc="invoice.currency_id.name"/></td>
                                        <td class="right"><t t-esc="'{:,.3f}'.format(invoice.amount_residual)"/> <t t-esc="invoice.currency_id.name"/></td>
                                        <td class="right"><t t-esc="'{:,.3f}'.format(invoice.amount_tax)"/> <t t-esc="invoice.currency_id.name"/></td>
                                    </tr>
                                </t>
                            </t>

                            <!-- If no invoices found, show payment allocation -->
                            <t t-if="not invoices">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #999;">
                                        Payment recorded - No specific invoice allocation
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>

                <!-- Authorized Signatory -->
                <div class="authorized-signature">
                    <div class="bold">Authorized Signatory</div>
                    <div class="signature-line"></div>
                </div>

                <!-- Signature Section -->
                <div class="signature-section">
                    <div class="signature-row">
                        <div class="signature-cell">
                            <div class="signature-label">Received By</div>
                        </div>
                        <div class="signature-cell">
                            <div class="signature-label">Prepared By</div>
                        </div>
                        <div class="signature-cell">
                            <div class="signature-label">Checked By</div>
                        </div>
                        <div class="signature-cell">
                            <div class="signature-label">Approved By</div>
                        </div>
                    </div>
                </div>

                <!-- Footer Info -->
                <div class="footer-info">
                    <t t-if="company.phone">Phone: <t t-esc="company.phone"/>&#160;&#160;</t>
                    <t t-if="company.email">Email: <t t-esc="company.email"/>&#160;&#160;</t>
                    <t t-if="company.vat">TRN: <t t-esc="company.vat"/></t>
                </div>

                <!-- Page Number -->
                <div class="page-number">
                    Page: 1 / 1
                </div>
            </div>
        </div>
    </template>

</odoo>