<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit Sale Order Form -->
    <record id="view_order_form_porter" model="ir.ui.view">
        <field name="name">sale.order.form.porter</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">

            <!-- Add Porter shipment button in header button box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_porter_shipments"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-truck"
                        invisible="porter_shipment_count == 0">
                    <field name="porter_shipment_count" widget="statinfo" string="Porter Shipments"/>
                </button>
            </xpath>

            <!-- Add carrier field after payment_term_id -->
            <xpath expr="//field[@name='payment_term_id']" position="after">
                <field name="carrier_id"
                       string="Delivery Method"
                       required="state in ['draft', 'sent']"
                       domain="[('active', '=', True), ('active_for_sales', '=', True)]"
                       options="{'no_create': True, 'no_create_edit': True}"
                       placeholder="Select delivery method..."
                       help="Select the delivery method for this order. Only active methods marked for sales are shown."
                       invisible="state not in ['draft', 'sent', 'sale']"/>
                <field name="is_porter_carrier" column_invisible="True"/>
                <field name="porter_service_type"
                       invisible="not is_porter_carrier"
                       readonly="1"/>
            </xpath>

            <!-- Add Porter tab in notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="Porter Express" invisible="not is_porter_carrier">
                    <group>
                        <group string="Shipment Information">
                            <field name="porter_awb_numbers" readonly="1"/>
                            <field name="porter_pickup_numbers" readonly="1"/>
                            <field name="porter_shipment_state"
                                   widget="badge"
                                   decoration-success="porter_shipment_state == 'delivered'"
                                   decoration-info="porter_shipment_state == 'in_transit'"
                                   decoration-warning="porter_shipment_state == 'confirmed'"
                                   decoration-danger="porter_shipment_state == 'cancelled'"
                                   readonly="1"/>
                        </group>
                        <group string="Tracking">
                            <field name="porter_tracking_urls"
                                   widget="url"
                                   readonly="1"
                                   invisible="not porter_tracking_urls"/>
                            <button name="action_open_porter_tracking"
                                    string="Track Shipment"
                                    type="object"
                                    class="btn-link"
                                    icon="fa-external-link"
                                    invisible="not porter_tracking_urls"/>
                        </group>
                    </group>

                    <!-- List of shipments -->
                    <separator string="Porter Shipments" invisible="porter_shipment_count == 0"/>
                    <field name="porter_shipment_ids" readonly="1" invisible="porter_shipment_count == 0">
                        <tree>
                            <field name="name" string="AWB Number"/>
                            <field name="reference2" string="Reference"/>
                            <field name="product_code" string="Service"/>
                            <field name="pieces"/>
                            <field name="weight"/>
                            <field name="cod_amount" optional="show"/>
                            <field name="state" widget="badge"
                                   decoration-success="state == 'delivered'"
                                   decoration-info="state == 'in_transit'"
                                   decoration-warning="state == 'confirmed'"
                                   decoration-danger="state == 'cancelled'"/>
                            <field name="pickup_date" optional="show"/>
                            <field name="delivery_date" optional="show"/>
                        </tree>
                    </field>
                </page>
            </xpath>

            <!-- Add status bar info -->
            <xpath expr="//field[@name='state']" position="before">
                <field name="porter_shipment_state"
                       widget="badge"
                       invisible="not is_porter_carrier or porter_shipment_state == 'none'"
                       decoration-success="porter_shipment_state == 'delivered'"
                       decoration-info="porter_shipment_state == 'in_transit'"
                       decoration-warning="porter_shipment_state == 'confirmed'"
                       decoration-danger="porter_shipment_state == 'cancelled'"/>
            </xpath>

        </field>
    </record>

    <!-- Add Porter info in Sale Order Tree View -->
    <record id="view_order_tree_porter" model="ir.ui.view">
        <field name="name">sale.order.tree.porter</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="before">
                <field name="carrier_id" optional="show" string="Delivery"/>
                <field name="porter_awb_numbers" optional="hide" string="Porter AWB"/>
            </xpath>
        </field>
    </record>

    <!-- Add search filters -->
    <record id="view_sales_order_filter_porter" model="ir.ui.view">
        <field name="name">sale.order.search.porter</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sales_order_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='my_sale_orders_filter']" position="after">
                <separator/>
                <filter string="Porter Express"
                        name="porter_orders"
                        domain="[('is_porter_carrier', '=', True)]"/>
                <filter string="Has Porter Shipment"
                        name="has_porter_shipment"
                        domain="[('picking_ids.porter_shipment_id', '!=', False)]"/>
            </xpath>
            <xpath expr="//group" position="inside">
                <filter string="Carrier"
                        name="group_by_carrier"
                        context="{'group_by': 'carrier_id'}"/>
                <filter string="Porter Status"
                        name="group_by_porter_status"
                        context="{'group_by': 'porter_shipment_state'}"/>
            </xpath>
        </field>
    </record>
</odoo>