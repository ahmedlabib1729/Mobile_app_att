<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ============ INHERIT FORM VIEW ============ -->
    <record id="view_shipment_order_form_cod" model="ir.ui.view">
        <field name="name">shipment.order.form.cod</field>
        <field name="model">shipment.order</field>
        <field name="inherit_id" ref="shipping_management_system.view_shipment_order_form"/>
        <field name="arch" type="xml">

            <!-- Add COD button in button box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" icon="fa-money"
                        name="action_view_cod_collection" type="object"
                        invisible="payment_method != 'cod' or not cod_collection_id"
                        groups="cod_management_system.group_cod_viewer">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">COD Status</span>
                        <span class="o_stat_value">
                            <field name="cod_collection_state" widget="badge"
                                   decoration-success="cod_collection_state == 'reconciled'"
                                   decoration-info="cod_collection_state == 'collected'"
                                   decoration-warning="cod_collection_state == 'in_settlement'"/>
                        </span>
                    </div>
                </button>
            </xpath>

            <!-- Add COD fields after payment method -->
            <field name="cod_amount" position="after">
                <field name="has_cod_collection" invisible="1"/>
                <field name="cod_collection_id" invisible="1"/>
            </field>

            <!-- Add COD actions in header -->
            <xpath expr="//header" position="inside">
                <button name="action_mark_cod_collected"
                        string="COD Collected"
                        type="object"
                        class="btn-warning"
                        invisible="not cod_collection_id or state != 'delivered' or cod_collection_state != 'delivered'"
                        groups="cod_management_system.group_cod_user"/>

                <button name="action_add_to_settlement"
                        string="Add to Settlement"
                        type="object"
                        invisible="not cod_collection_id or cod_collection_state != 'collected'"
                        groups="cod_management_system.group_cod_user"/>
            </xpath>

            <!-- Add COD tab in notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="COD Management" name="cod_management"
                      invisible="payment_method != 'cod'"
                      groups="cod_management_system.group_cod_viewer">

                    <group invisible="not cod_collection_id">
                        <group string="COD Status">
                            <field name="cod_collection_state" widget="badge"
                                   decoration-success="cod_collection_state == 'reconciled'"
                                   decoration-info="cod_collection_state == 'collected'"
                                   decoration-warning="cod_collection_state == 'in_settlement'"/>
                            <field name="cod_expected_settlement"/>
                            <field name="cod_actual_settlement"/>
                            <field name="cod_settlement_batch_id" readonly="1"/>
                        </group>

                        <group string="Financial">
                            <field name="cod_commission" widget="monetary"/>
                            <field name="cod_net_amount" widget="monetary" class="fw-bold text-primary"/>
                        </group>
                    </group>

                    <group string="COD Collection Summary">
                        <field name="cod_collection_summary"
                               widget="text"
                               readonly="1"
                               nolabel="1"/>
                    </group>

                    <group invisible="cod_collection_id">
                        <button name="action_create_cod_collection"
                                string="Create COD Collection"
                                type="object"
                                class="btn-primary"
                                invisible="cod_amount &lt;= 0"
                                groups="cod_management_system.group_cod_user"/>
                        <div class="alert alert-warning" role="alert">
                            <i class="fa fa-info-circle"/> No COD collection record exists for this shipment.
                            COD collection records are normally created automatically when COD shipments are confirmed.
                        </div>
                    </group>
                </page>
            </xpath>

        </field>
    </record>

    <!-- ============ INHERIT LIST VIEW ============ -->
    <record id="view_shipment_order_tree_cod" model="ir.ui.view">
        <field name="name">shipment.order.tree.cod</field>
        <field name="model">shipment.order</field>
        <field name="inherit_id" ref="shipping_management_system.view_shipment_order_list"/>
        <field name="arch" type="xml">

            <field name="state" position="after">
                <field name="cod_collection_state"
                       string="COD Status"
                       widget="badge"
                       optional="show"
                       invisible="payment_method != 'cod'"
                       groups="cod_management_system.group_cod_viewer"
                       decoration-success="cod_collection_state == 'reconciled'"
                       decoration-info="cod_collection_state == 'collected'"
                       decoration-warning="cod_collection_state == 'in_settlement'"/>

                <field name="cod_net_amount"
                       widget="monetary"
                       optional="hide"
                       invisible="payment_method != 'cod'"
                       groups="cod_management_system.group_cod_viewer"/>
            </field>

        </field>
    </record>

    <!-- ============ INHERIT SEARCH VIEW ============ -->
    <record id="view_shipment_order_search_cod" model="ir.ui.view">
        <field name="name">shipment.order.search.cod</field>
        <field name="model">shipment.order</field>
        <field name="inherit_id" ref="shipping_management_system.view_shipment_order_search"/>
        <field name="arch" type="xml">

            <filter name="cod" position="after">
                <separator groups="cod_management_system.group_cod_viewer"/>
                <filter name="cod_pending" string="COD Pending"
                        domain="[('cod_collection_state', '=', 'pending')]"
                        groups="cod_management_system.group_cod_viewer"/>
                <filter name="cod_collected" string="COD Collected"
                        domain="[('cod_collection_state', '=', 'collected')]"
                        groups="cod_management_system.group_cod_viewer"/>
                <filter name="cod_in_settlement" string="COD In Settlement"
                        domain="[('cod_collection_state', '=', 'in_settlement')]"
                        groups="cod_management_system.group_cod_viewer"/>
                <filter name="cod_settled" string="COD Settled"
                        domain="[('cod_collection_state', '=', 'settled')]"
                        groups="cod_management_system.group_cod_viewer"/>
            </filter>

            <filter name="state" position="after">
                <filter name="group_cod_status" string="COD Status"
                        context="{'group_by': 'cod_collection_state'}"
                        groups="cod_management_system.group_cod_viewer"/>
            </filter>

        </field>
    </record>

</odoo>