<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ============ INHERIT FORM VIEW ============ -->
    <record id="view_shipment_order_form_cod" model="ir.ui.view">
        <field name="name">shipment.order.form.cod</field>
        <field name="model">shipment.order</field>
        <field name="inherit_id" ref="shipping_management_system.view_shipment_order_form"/>
        <field name="arch" type="xml">

            <!-- Add COD button in button box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" icon="fa-money"
                        name="action_view_cod_collection" type="object"
                        invisible="payment_method != 'cod' or not cod_collection_id"
                        groups="cod_management_system.group_cod_viewer">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">COD Status</span>
                        <span class="o_stat_value">
                            <field name="cod_collection_state" widget="badge"/>
                        </span>
                    </div>
                </button>
            </xpath>

            <!-- Add COD fields after payment method -->
            <field name="cod_amount" position="after">
                <field name="has_cod_collection" invisible="1"/>
                <field name="cod_collection_id" invisible="1"/>
            </field>

            <!-- Add COD actions in header -->
            <xpath expr="//header" position="inside">
                <button name="action_mark_cod_collected"
                        string="COD Collected"
                        type="object"
                        class="btn-warning"
                        invisible="not cod_collection_id or state != 'delivered' or cod_collection_state != 'delivered'"
                        groups="cod_management_system.group_cod_user"/>

                <button name="action_add_to_settlement"
                        string="Add to Settlement"
                        type="object"
                        invisible="not cod_collection_id or cod_collection_state != 'collected'"
                        groups="cod_management_system.group_cod_user"/>

                <button name="action_recalculate_fees"
                        string="‚ü≥ Recalculate All"
                        type="object"
                        class="btn-info"
                        invisible="payment_method != 'cod'"
                        groups="cod_management_system.group_cod_user"/>
            </xpath>

            <!-- Add COD tab in notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="COD Management" name="cod_management"
                      invisible="payment_method != 'cod'"
                      groups="cod_management_system.group_cod_viewer">

                    <!-- ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ: ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≠ÿµŸÑÿ© -->
                    <group string="üí∞ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≠ÿµŸÑÿ©" invisible="not cod_collection_id">
                        <group>
                            <field name="cod_amount" widget="monetary" readonly="1"
                                   string="ÿßŸÑŸÖÿ≠ÿµŸÑ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ" class="fw-bold"/>
                            <separator string="ÿÆÿµŸàŸÖÿßÿ™ ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ¥ÿ≠ŸÜ"/>
                            <field name="base_shipping_cost" widget="monetary" readonly="1"/>
                            <field name="weight_shipping_cost" widget="monetary" readonly="1"/>
                            <field name="cod_fee_amount" widget="monetary" readonly="1" string="ÿπŸÖŸàŸÑÿ© COD"/>
                            <field name="insurance_fee_amount" widget="monetary" readonly="1"/>
                            <field name="pickup_fee" widget="monetary" readonly="1"/>
                        </group>
                        <group>
                            <field name="shipping_cost" widget="monetary" readonly="1"
                                   string="ÿ•ÿ¨ŸÖÿßŸÑŸä ÿÆÿµŸàŸÖÿßÿ™ ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ¥ÿ≠ŸÜ"
                                   class="fw-bold text-danger"/>
                            <separator/>
                            <field name="cod_net_amount" widget="monetary" readonly="1"
                                   string="ÿßŸÑÿµÿßŸÅŸä ŸÖŸÜ ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ¥ÿ≠ŸÜ"
                                   class="fw-bold text-info"/>
                        </group>
                    </group>

                    <!-- ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ´ÿßŸÜŸä: ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÜŸáÿßÿ¶Ÿä -->
                    <group string="üíé ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÜŸáÿßÿ¶Ÿä" invisible="not cod_collection_id">
                        <group>
                            <field name="total_company_cost" widget="monetary" readonly="1"
                                   string="üè¢ ÿ±ÿ®ÿ≠ŸÉ (ÿ£ÿ™ÿπÿßÿ® ÿ¥ÿ±ŸÉÿ™ŸÉ)"
                                   class="fw-bold text-success"/>
                            <div class="text-muted">
                                <small>Ÿáÿ∞ÿß ÿßŸÑŸÖÿ®ŸÑÿ∫ ŸáŸà ÿ±ÿ®ÿ≠ŸÉ ŸÉŸàÿ≥Ÿäÿ∑</small>
                            </div>
                        </group>
                        <group>
                            <!-- ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ±ÿ™ÿ¨ÿπ ŸÑŸÑÿπŸÖŸäŸÑ -->
                            <div class="o_field_widget">
                                <span class="o_form_label">üë§ ŸäŸèÿ±ÿØ ŸÑŸÑÿπŸÖŸäŸÑ</span>
                                <div class="fw-bold text-primary" style="font-size: 1.2em;">
                                    <field name="cod_net_amount" nolabel="1" readonly="1" class="d-inline"/> -
                                    <field name="total_company_cost" nolabel="1" readonly="1" class="d-inline"/> =
                                    <span id="customer_return_amount" class="fw-bold">
                                        <!-- ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ≥ÿßÿ®Ÿá ÿ®ŸÄ JavaScript -->
                                    </span> ÿ¨ŸÜŸäŸá
                                </div>
                                <div class="text-muted">
                                    <small>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ∞Ÿä ÿ≥ŸäŸèÿ±ÿØ ŸÑŸÑÿπŸÖŸäŸÑ ÿ®ÿπÿØ ÿÆÿµŸÖ ÿ£ÿ™ÿπÿßÿ®ŸÉ</small>
                                </div>
                            </div>
                        </group>
                    </group>

                    <!-- ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ´ÿßŸÑÿ´: ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ -->
                    <group string="üìä ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ" invisible="not cod_collection_id">
                        <notebook>
                            <page string="ÿ™ŸÉŸÑŸÅÿ© ÿ¥ÿ±ŸÉÿ™ŸÉ">
                                <group>
                                    <group>
                                        <field name="company_base_cost" widget="monetary" readonly="1"/>
                                        <field name="company_weight_cost" widget="monetary" readonly="1"/>
                                        <field name="company_handling_fee" widget="monetary" readonly="1"/>
                                    </group>
                                    <group>
                                        <field name="total_broker_fees" widget="monetary" readonly="1"/>
                                        <field name="discount_amount" widget="monetary" readonly="1"
                                               invisible="discount_amount == 0"/>
                                        <separator/>
                                        <field name="total_company_cost" widget="monetary" readonly="1"
                                               string="ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä" class="fw-bold"/>
                                    </group>
                                </group>
                            </page>
                            <page string="ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ≥ŸàŸäÿ©">
                                <group>
                                    <group>
                                        <field name="cod_collection_state" widget="badge"/>
                                        <field name="cod_expected_settlement"/>
                                        <field name="cod_actual_settlement"/>
                                    </group>
                                    <group>
                                        <field name="cod_settlement_batch_id" readonly="1"/>
                                        <field name="cod_commission" widget="monetary"/>
                                    </group>
                                </group>
                            </page>
                        </notebook>
                    </group>

                    <!-- ÿßŸÑŸÖŸÑÿÆÿµ -->
                    <separator string="üìã ÿßŸÑŸÖŸÑÿÆÿµ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸä"/>
                    <field name="cod_collection_summary" widget="text" readonly="1" nolabel="1"/>

                    <!-- ÿ±ÿ≥ÿßŸÑÿ© ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ COD Collection -->
                    <group invisible="cod_collection_id">
                        <div class="alert alert-warning" role="alert">
                            <h4 class="alert-heading">
                                <i class="fa fa-warning"/> No COD Collection Record
                            </h4>
                            <p>This COD shipment doesn't have a collection record yet.</p>
                            <button name="action_create_cod_collection"
                                    string="Create COD Collection"
                                    type="object"
                                    class="btn btn-primary"
                                    invisible="cod_amount == 0"
                                    groups="cod_management_system.group_cod_user"/>
                        </div>
                    </group>

                </page>
            </xpath>

        </field>
    </record>

    <!-- ============ INHERIT LIST VIEW ============ -->
    <record id="view_shipment_order_tree_cod" model="ir.ui.view">
        <field name="name">shipment.order.tree.cod</field>
        <field name="model">shipment.order</field>
        <field name="inherit_id" ref="shipping_management_system.view_shipment_order_list"/>
        <field name="arch" type="xml">

            <field name="state" position="after">
                <field name="cod_collection_state"
                       string="COD Status"
                       widget="badge"
                       optional="show"
                       invisible="payment_method != 'cod'"
                       groups="cod_management_system.group_cod_viewer"/>
                <field name="cod_net_amount"
                       string="COD Net"
                       widget="monetary"
                       optional="hide"
                       invisible="payment_method != 'cod'"
                       groups="cod_management_system.group_cod_viewer"/>
            </field>

        </field>
    </record>

    <!-- ============ INHERIT SEARCH VIEW ============ -->
    <record id="view_shipment_order_search_cod" model="ir.ui.view">
        <field name="name">shipment.order.search.cod</field>
        <field name="model">shipment.order</field>
        <field name="inherit_id" ref="shipping_management_system.view_shipment_order_search"/>
        <field name="arch" type="xml">

            <filter name="cod" position="after">
                <separator groups="cod_management_system.group_cod_viewer"/>
                <filter name="cod_pending" string="COD Pending"
                        domain="[('cod_collection_state', '=', 'pending')]"
                        groups="cod_management_system.group_cod_viewer"/>
                <filter name="cod_collected" string="COD Collected"
                        domain="[('cod_collection_state', '=', 'collected')]"
                        groups="cod_management_system.group_cod_viewer"/>
                <filter name="cod_in_settlement" string="COD In Settlement"
                        domain="[('cod_collection_state', '=', 'in_settlement')]"
                        groups="cod_management_system.group_cod_viewer"/>
                <filter name="cod_settled" string="COD Settled"
                        domain="[('cod_collection_state', '=', 'settled')]"
                        groups="cod_management_system.group_cod_viewer"/>
            </filter>

            <filter name="state" position="after">
                <filter name="group_cod_status" string="COD Status"
                        context="{'group_by': 'cod_collection_state'}"
                        groups="cod_management_system.group_cod_viewer"/>
            </filter>

        </field>
    </record>

</odoo>